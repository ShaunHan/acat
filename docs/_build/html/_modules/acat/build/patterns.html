

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>acat.build.patterns &mdash; ACAT 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/table_styling.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ACAT
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build.html">Building things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ga.html">Genetic Algorithm</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ACAT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>acat.build.patterns</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for acat.build.patterns</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">..settings</span> <span class="kn">import</span> <span class="n">adsorbate_elements</span><span class="p">,</span> <span class="n">site_heights</span>  
<span class="kn">from</span> <span class="nn">..settings</span> <span class="kn">import</span> <span class="n">monodentate_adsorbate_list</span><span class="p">,</span> <span class="n">multidentate_adsorbate_list</span>
<span class="kn">from</span> <span class="nn">..adsorption_sites</span> <span class="kn">import</span> <span class="n">ClusterAdsorptionSites</span><span class="p">,</span> <span class="n">SlabAdsorptionSites</span>
<span class="kn">from</span> <span class="nn">..adsorption_sites</span> <span class="kn">import</span> <span class="n">group_sites_by_facet</span>
<span class="kn">from</span> <span class="nn">..adsorbate_coverage</span> <span class="kn">import</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">,</span> <span class="n">SlabAdsorbateCoverage</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">is_list_or_tuple</span><span class="p">,</span> <span class="n">get_mic</span><span class="p">,</span> <span class="n">atoms_too_close_after_addition</span> 
<span class="kn">from</span> <span class="nn">..labels</span> <span class="kn">import</span> <span class="n">get_cluster_signature_from_label</span><span class="p">,</span> <span class="n">get_slab_signature_from_label</span>
<span class="kn">from</span> <span class="nn">.actions</span> <span class="kn">import</span> <span class="n">add_adsorbate_to_site</span><span class="p">,</span> <span class="n">remove_adsorbate_from_site</span> 
<span class="kn">from</span> <span class="nn">ase.io</span> <span class="kn">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">Trajectory</span>
<span class="kn">from</span> <span class="nn">ase.formula</span> <span class="kn">import</span> <span class="n">Formula</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">networkx.algorithms.isomorphism</span> <span class="k">as</span> <span class="nn">iso</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">random</span>


<div class="viewcode-block" id="StochasticPatternGenerator"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.StochasticPatternGenerator">[docs]</a><span class="k">class</span> <span class="nc">StochasticPatternGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`StochasticPatternGenerator` is a class for generating </span>
<span class="sd">    adsorbate coverage patterns stochastically. Graph isomorphism</span>
<span class="sd">    is implemented to identify identical coverage patterns.</span>
<span class="sd">    4 adsorbate actions are supported: add, remove, move, replace. </span>
<span class="sd">    The function is generalized for both periodic and non-periodic </span>
<span class="sd">    systems (distinguished by atoms.pbc). </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : ase.Atoms object or list of ase.Atoms objects</span>
<span class="sd">        The structure to perform the adsorbate action on. If </span>
<span class="sd">        a list of structures is provided, perform adsorbate </span>
<span class="sd">        action on one of the structures in each step. </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    image_probabilities : listt, default None</span>
<span class="sd">        A list of the probabilities of selecting each structure.</span>
<span class="sd">        Selecting structure with equal probability if not specified.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>
<span class="sd">        Adding adsorbate species with equal probability if not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    adsorption_sites : acat.AdsorptionSites object, default None</span>
<span class="sd">        Provide AdsorptionSites object to accelerate the pattern </span>
<span class="sd">        generation. Make sure all the structures have the same </span>
<span class="sd">        periodicity and atom indexing. If composition_effect=True, </span>
<span class="sd">        you should only provide adsorption_sites when the surface </span>
<span class="sd">        composition is fixed.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        Only required if the structure is a periodic surface slab.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        beneath fcc hollow sites.</span>

<span class="sd">    composition_effect : bool, default False</span>
<span class="sd">        Whether to consider sites with different elemental </span>
<span class="sd">        compositions as different sites. It is recommended to </span>
<span class="sd">        set composition=False for monometallics.</span>

<span class="sd">    dmax : float, default 2.5</span>
<span class="sd">        The maximum bond length (in Angstrom) between the site and the </span>
<span class="sd">        bonding atom  that should be considered as an adsorbate.</span>

<span class="sd">    species_forbidden_sites : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of the site (can be one or multiple site types) that the </span>
<span class="sd">        speices is not allowed to add to. All sites are availabe for a</span>
<span class="sd">        species if not specified. Note that this does not differentiate</span>
<span class="sd">        sites with different compositions.</span>

<span class="sd">    species_forbidden_labels : dict, default None</span>
<span class="sd">        Same as species_forbidden_sites except that the adsorption sites</span>
<span class="sd">        are written as numerical labels according to acat.labels. Useful</span>
<span class="sd">        when you need to differentiate sites with different compositions.</span>

<span class="sd">    fragmentation : bool, default True</span>
<span class="sd">        Whether to cut multidentate species into fragments. This ensures </span>
<span class="sd">        that multidentate species with different orientations are</span>
<span class="sd">        considered as different coverage patterns.</span>

<span class="sd">    trajectory : str, default &#39;patterns.traj&#39;</span>
<span class="sd">        The name of the output ase trajectory file.</span>

<span class="sd">    append_trajectory : bool, default False</span>
<span class="sd">        Whether to append structures to the existing trajectory. </span>
<span class="sd">        If only unique patterns are accepted, the code will also check </span>
<span class="sd">        graph isomorphism for the existing structures in the trajectory.</span>
<span class="sd">        This is also useful when you want to generate coverage patterns </span>
<span class="sd">        stochastically but for all images systematically, e.g. generating</span>
<span class="sd">        10 stochastic coverage patterns for each image:</span>
<span class="sd">        from acat.build.patterns import StochasticPatternGenerator as SPG</span>
<span class="sd">        for atoms in images:</span>
<span class="sd">            spg = SPG(atoms, ..., append_trajectory=True)</span>
<span class="sd">            spg.run(ngen = 10)</span>

<span class="sd">    logfile : str, default &#39;patterns.log&#39;</span>
<span class="sd">        The name of the log file.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    The following example illustrates how to generate 100 stochastic</span>
<span class="sd">    adsorbate coverage patterns with CO, OH, CH3 and CHO, based on </span>
<span class="sd">    10 Pt fcc111 surface slabs with random C and O coverages, where </span>
<span class="sd">    CH3 is forbidden to be added to ontop and bridge sites:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import StochasticPatternGenerator as SPG</span>
<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import random_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import fcc111</span>
<span class="sd">        &gt;&gt;&gt; slab = fcc111(&#39;Pt&#39;, (6, 6, 4), 4, vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; slab.center()</span>
<span class="sd">        &gt;&gt;&gt; images = []</span>
<span class="sd">        &gt;&gt;&gt; for _ in range(10):</span>
<span class="sd">        ...     atoms = slab.copy()</span>
<span class="sd">        ...     image = random_coverage_pattern(atoms, adsorbate_species=[&#39;C&#39;,&#39;O&#39;],</span>
<span class="sd">        ...                                     surface=&#39;fcc111&#39;,</span>
<span class="sd">        ...                                     min_adsorbate_distance=5.)</span>
<span class="sd">        ...     images.append(image)</span>
<span class="sd">        &gt;&gt;&gt; spg = SPG(images, adsorbate_species=[&#39;CO&#39;,&#39;OH&#39;,&#39;CH3&#39;,&#39;CHO&#39;],</span>
<span class="sd">        ...           species_probabilities={&#39;CO&#39;:0.3, &#39;OH&#39;: 0.3, </span>
<span class="sd">        ...                                  &#39;CH3&#39;: 0.2, &#39;CHO&#39;: 0.2},</span>
<span class="sd">        ...           min_adsorbate_distance=1.5, </span>
<span class="sd">        ...           surface=&#39;fcc111&#39;,</span>
<span class="sd">        ...           composition_effect=False, </span>
<span class="sd">        ...           species_forbidden_sites={&#39;CH3&#39;: [&#39;ontop&#39;,&#39;bridge&#39;]})</span>
<span class="sd">        &gt;&gt;&gt; spg.run(n_gen=100, actions=&#39;add&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>                                                       
                 <span class="n">adsorbate_species</span><span class="p">,</span>
                 <span class="n">image_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                 <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">composition_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dmax</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>                 
                 <span class="n">species_forbidden_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    
                 <span class="n">species_forbidden_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fragmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;patterns.traj&#39;</span><span class="p">,</span>
                 <span class="n">append_trajectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;patterns.log&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>                     
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                                 <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> 
                                       <span class="n">monodentate_adsorbate_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span>
                                        <span class="n">multidentate_adsorbate_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">-</span> 
                        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;species </span><span class="si">{}</span><span class="s1"> are not defined &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;in adsorbate_list in acat.settings&#39;</span><span class="p">)</span>             

        <span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span> <span class="o">=</span> <span class="n">image_probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="o">=</span> <span class="n">species_probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> 
                                             <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">]</span>               
         
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span> <span class="o">=</span> <span class="n">min_adsorbate_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heights</span> <span class="o">=</span> <span class="n">site_heights</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="n">species_forbidden_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="n">species_forbidden_labels</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                             <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span> <span class="o">=</span> <span class="n">fragmentation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="o">=</span> <span class="n">append_trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>      
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">allow_6fold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">composition_effect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="n">allow_6fold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="n">composition_effect</span>

    <span class="k">def</span> <span class="nf">_add_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>     
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span><span class="p">:</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span> 
                                               <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                                                
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
            <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                    <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>            
                                                                                             
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    
                                                                                             
        <span class="c1"># Only add one adsorabte to a site at least 2 shells </span>
        <span class="c1"># away from currently occupied sites</span>
        <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span>
                <span class="n">forb_labs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                   

                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forb_labs</span><span class="p">]</span>    

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nsids</span><span class="p">:</span>                                                             
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to any site. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                                                                             
        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="n">subsurf_site</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nsi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">subsurf_site</span><span class="p">:</span> 
            <span class="n">nsi</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nsids</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
                                                                                             
        <span class="n">nst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>            
        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                                   
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> 
                                       <span class="o">+</span> <span class="s1">&#39;to any site. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>            
                                                                                             
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>                                 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                            

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span> 
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                           
        <span class="c1"># Make sure there no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">])</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">nsac</span>                                                                

    <span class="k">def</span> <span class="nf">_remove_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span> 
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                    
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Removal failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">rmst</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied</span><span class="p">)</span>
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">)</span>

        <span class="n">ads_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ads_remain</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Last adsorbate has been removed &#39;</span> <span class="o">+</span> 
                                   <span class="s1">&#39;from image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_image</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                      
        <span class="k">return</span> <span class="n">nsac</span> 

    <span class="k">def</span> <span class="nf">_move_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                         
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>                         
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">rmst</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied</span><span class="p">)</span>
        <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">)</span>

        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>
                                                                                        
        <span class="c1"># Only add one adsorabte to a site at least 2 shells </span>
        <span class="c1"># away from currently occupied sites</span>
        <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span>
                <span class="n">forb_labs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                   
                                                                                             
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forb_labs</span><span class="p">]</span>   

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nsids</span><span class="p">:</span>                                                             
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to place </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;on any other site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                                                                        
        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="n">subsurf_site</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nsi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">subsurf_site</span><span class="p">:</span> 
            <span class="n">nsi</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nsids</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
                                                                                        
        <span class="n">nst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>            
        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                   
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to place </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> 
                                       <span class="o">+</span> <span class="s1">&#39;on any other site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>
                                                                                        
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span> 
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                          

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                           
        <span class="c1"># Make sure there no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
        <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The new position of </span><span class="si">{}</span><span class="s1"> is too &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;close to another adsorbate. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The new position of </span><span class="si">{}</span><span class="s1"> is too &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;close to another adsorbate. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
 
        <span class="k">return</span> <span class="n">nsac</span>                                                                 

    <span class="k">def</span> <span class="nf">_replace_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>                     
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                      
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied_stids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsl</span><span class="p">))</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_stids</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">rpsti</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied_stids</span><span class="p">)</span>
        <span class="n">rpst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rpst</span><span class="p">)</span>

        <span class="c1"># Select a different adsorbate with probability </span>
        <span class="n">old_adsorbate</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
        <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_adsorbate</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                         <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                        <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                                                                                                 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                                                                                            
                    <span class="k">if</span> <span class="n">lab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                        <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>                                                       

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                      
            <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                        <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>

        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="ow">and</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">new_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">]</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">new_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                      
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>  
                                       <span class="o">+</span> <span class="s1">&#39;to any site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>
                                                                                            
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>                     
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span>
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                 
 
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>   
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>         
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>                            
                                                                           
        <span class="c1"># Make sure there no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
        <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">nsac</span>                        
 
    <span class="sd">&#39;&#39;&#39;unique: whether discard duplicates based on isomorphism or not&#39;&#39;&#39;</span>
<div class="viewcode-block" id="StochasticPatternGenerator.run"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.StochasticPatternGenerator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_gen</span><span class="p">,</span> 
            <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span><span class="s1">&#39;move&#39;</span><span class="p">],</span> 
            <span class="n">action_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
 
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">actions</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_action_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">action_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span><span class="p">:</span>                                 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading graphs for existing structures in &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">. This might take a while.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">prev_images</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">patoms</span> <span class="ow">in</span> <span class="n">prev_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
                <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span> 
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                 <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>           
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                    <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>        

                <span class="n">plabs</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="n">pG</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plabs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pG</span><span class="p">)</span>

        <span class="n">n_new</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Start the iteration</span>
        <span class="k">while</span> <span class="n">n_new</span> <span class="o">&lt;</span> <span class="n">n_gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_old</span> <span class="o">==</span> <span class="n">n_new</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generating pattern </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_new</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">n_old</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Select image with probability </span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> 
                                            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_image</span> <span class="o">=</span> <span class="n">n_new</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
            <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>      
            <span class="c1"># Choose an action </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">nslab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">nslab</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;add&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>                                                             
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There is no adsorbate in image </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_new</span><span class="p">)</span>
                                  <span class="o">+</span> <span class="s2">&quot;The only available action is &#39;add&#39;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">action_probabilities</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span> 
                                            <span class="n">weights</span><span class="o">=</span><span class="n">all_action_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Action: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>             
                <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
                <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
                <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                        <span class="c1"># Skip duplicates based on isomorphism </span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">categorical_node_match</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                        <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span> 
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="ow">and</span> <span class="n">potential_graphs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                              
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Duplicate found by label match. &#39;</span>
                                                   <span class="o">+</span> <span class="s1">&#39;Discarded!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> 
                        <span class="n">nx</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Duplicate found by isomorphism. &#39;</span>
                                                   <span class="o">+</span> <span class="s1">&#39;Discarded!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                            <span class="k">continue</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern generated: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
            <span class="n">n_new</span> <span class="o">+=</span> <span class="mi">1</span></div></div>


<div class="viewcode-block" id="SystematicPatternGenerator"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.SystematicPatternGenerator">[docs]</a><span class="k">class</span> <span class="nc">SystematicPatternGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`SystematicPatternGenerator` is a class for generating </span>
<span class="sd">    adsorbate coverage patterns systematically. This is useful to </span>
<span class="sd">    enumerate all unique patterns at low coverage, but explodes at</span>
<span class="sd">    higher coverages. Graph isomorphism is implemented to identify </span>
<span class="sd">    identical coverage patterns. 4 adsorbate actions are supported: </span>
<span class="sd">    add, remove, move, replace. The function is generalized for both</span>
<span class="sd">    periodic and non-periodic systems (distinguished by atoms.pbc). </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : ase.Atoms object or list of ase.Atoms objects</span>
<span class="sd">        The structure to perform the adsorbate action on. If </span>
<span class="sd">        a list of structures is provided, perform adsorbate </span>
<span class="sd">        action on one of the structures in each step. </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    adsorption_sites : acat.AdsorptionSites object, default None</span>
<span class="sd">        Provide AdsorptionSites object to accelerate the pattern </span>
<span class="sd">        generation. Make sure all the structures have the same </span>
<span class="sd">        periodicity and atom indexing. If composition_effect=True, </span>
<span class="sd">        you should only provide adsorption_sites when the surface </span>
<span class="sd">        composition is fixed.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        Only required if the structure is a periodic surface slab.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        beneath fcc hollow sites.</span>

<span class="sd">    composition_effect : bool, default False</span>
<span class="sd">        Whether to consider sites with different elemental </span>
<span class="sd">        compositions as different sites. It is recommended to </span>
<span class="sd">        set composition=False for monometallics.</span>

<span class="sd">    dmax : float, default 2.5</span>
<span class="sd">        The maximum bond length (in Angstrom) between the site and the </span>
<span class="sd">        bonding atom  that should be considered as an adsorbate.</span>

<span class="sd">    species_forbidden_sites : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of the site (can be one or multiple site types) that the </span>
<span class="sd">        speices is not allowed to add to. All sites are availabe for a</span>
<span class="sd">        species if not specified. Note that this does not differentiate</span>
<span class="sd">        sites with different compositions.</span>

<span class="sd">    species_forbidden_labels : dict, default None</span>
<span class="sd">        Same as species_forbidden_sites except that the adsorption sites</span>
<span class="sd">        are written as numerical labels according to acat.labels. Useful</span>
<span class="sd">        when you need to differentiate sites with different compositions.</span>

<span class="sd">    enumerate_orientations: bool, default True</span>
<span class="sd">        Whether to enumerate all orientations of multidentate species.</span>
<span class="sd">        This ensures that multidentate species with different orientations </span>
<span class="sd">        are all enumerated.</span>

<span class="sd">    trajectory : str, default &#39;patterns.traj&#39;</span>
<span class="sd">        The name of the output ase trajectory file.</span>

<span class="sd">    append_trajectory : bool, default False</span>
<span class="sd">        Whether to append structures to the existing trajectory. </span>
<span class="sd">        If only unique patterns are accepted, the code will also check </span>
<span class="sd">        graph isomorphism for the existing structures in the trajectory.</span>
<span class="sd">        This is also useful when you want to generate coverage patterns </span>
<span class="sd">        stochastically but for all images systematically, e.g. generating</span>
<span class="sd">        10 stochastic coverage patterns for each image:</span>
<span class="sd">        from acat.build.patterns import StochasticPatternGenerator as SPG</span>
<span class="sd">        for atoms in images:</span>
<span class="sd">            spg = SPG(atoms, ..., append_trajectory=True)</span>
<span class="sd">            spg.run(ngen = 10)</span>

<span class="sd">    logfile : str, default &#39;patterns.log&#39;</span>
<span class="sd">        The name of the log file.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    The following example illustrates how to add CO to all unique sites on </span>
<span class="sd">    a cuboctahedral bimetallic nanoparticle:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import ClusterAdsorptionSites</span>
<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import SystematicPatternGenerator as SPG</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Octahedron</span>
<span class="sd">        &gt;&gt;&gt; atoms = Octahedron(&#39;Cu&#39;, length=7, cutoff=3)</span>
<span class="sd">        &gt;&gt;&gt; for atom in atoms:</span>
<span class="sd">        ...     if atom.index % 2 == 0:</span>
<span class="sd">        ...         atom.symbol = &#39;Au&#39; </span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; cas = ClusterAdsorptionSites(atoms, composition_effect=True)</span>
<span class="sd">        &gt;&gt;&gt; spg = SPG(atoms, adsorbate_species=&#39;CO&#39;,</span>
<span class="sd">        ...           min_adsorbate_distance=2., </span>
<span class="sd">        ...           adsorption_sites=cas,</span>
<span class="sd">        ...           composition_effect=True) </span>
<span class="sd">        &gt;&gt;&gt; spg.run(action=&#39;add&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>                                                     
                 <span class="n">adsorbate_species</span><span class="p">,</span>
                 <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                 <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">composition_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dmax</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                 <span class="n">species_forbidden_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">species_forbidden_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">enumerate_orientations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;patterns.traj&#39;</span><span class="p">,</span>
                 <span class="n">append_trajectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;patterns.log&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>                     
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                                 <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> 
                                       <span class="n">monodentate_adsorbate_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span>
                                        <span class="n">multidentate_adsorbate_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">-</span> 
                        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;species </span><span class="si">{}</span><span class="s1"> is not defined &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;in adsorbate_list in acat.settings&#39;</span><span class="p">)</span>             

        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span> <span class="o">=</span> <span class="n">min_adsorbate_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heights</span> <span class="o">=</span> <span class="n">site_heights</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="n">species_forbidden_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="n">species_forbidden_labels</span>
                                                                                           
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                             <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span> <span class="o">=</span> <span class="n">enumerate_orientations</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>                        
        <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="o">=</span> <span class="n">append_trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>                 
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">allow_6fold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">composition_effect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="n">allow_6fold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="n">composition_effect</span>

    <span class="k">def</span> <span class="nf">_add_adsorbate_enumeration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                         
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 
       
        <span class="c1"># Take care of clean surface slab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span><span class="p">:</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>    
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                               <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
            <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                    <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Only add one adsorabte to a site at least 2 shells away from</span>
        <span class="c1"># currently occupied sites</span>
        <span class="n">newsites</span><span class="p">,</span> <span class="n">binbids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                    <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">binbis</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">binbis</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span> 
                    <span class="n">binbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binbis</span><span class="p">)</span>
                <span class="n">newsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newsites</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>                                                                             
                                                                                                     
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                          
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                     
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>
                    <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf sites</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
 
                    <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
  
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>        
 
                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
  
                    <span class="c1"># Make sure there no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span>                   
                                       <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span>
                    <span class="n">adsorbate</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="c1"># If the surface slab is clean, the potentially isomorphic</span>
                                <span class="c1"># graphs are all isomorphic</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="ow">and</span> <span class="n">potential_graphs</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="n">nm</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">categorical_node_match</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> 
                                <span class="n">nx</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>            
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                         <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_remove_adsorbate_enumeration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>                                                           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Removal failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rmst</span> <span class="ow">in</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">)</span>

            <span class="n">ads_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ads_remain</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Last adsorbate has been removed &#39;</span> <span class="o">+</span> 
                                       <span class="s1">&#39;from image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_image</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                     <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                <span class="k">return</span>
                                                      
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                             <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>

            <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                        <span class="c1"># Skip duplicates based on isomorphism </span>
                        <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">categorical_node_match</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> 
                        <span class="n">nx</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                 <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                    <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_move_adsorbate_enumeration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>                                                           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>                      
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                            
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>  
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span><span class="p">,</span> <span class="n">occupied</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">occupied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>                                                       
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                              
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
 
            <span class="c1"># Only add one adsorabte to a site at least 2 shells away from</span>
            <span class="c1"># currently occupied sites</span>
            <span class="n">newsites</span><span class="p">,</span> <span class="n">binbids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">binbis</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">binbis</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                            <span class="k">continue</span> 
                        <span class="n">binbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binbis</span><span class="p">)</span>
                    <span class="n">newsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newsites</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>                                                          

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                          
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>
                    <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf </span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                     
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
      
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>       

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>   
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
      
                    <span class="c1"># Make sure there no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">final_atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span>                   
                                             <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>                                                                                   

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                      
      
                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="n">nm</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">categorical_node_match</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> 
                                <span class="n">nx</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>            
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                                                                                             
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                         <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_replace_adsorbate_enumeration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                           
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied_stids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsl</span><span class="p">))</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_stids</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                
        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rpsti</span> <span class="ow">in</span> <span class="n">occupied_stids</span><span class="p">:</span>                                                         
            <span class="n">rpst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                             
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rpst</span><span class="p">)</span>
                                                                                             
            <span class="c1"># Select a different adsorbate with probability </span>
            <span class="n">old_adsorbate</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_adsorbate</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                             <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                                                                                                 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                            
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="p">:</span>
                            <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>                                                       

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                      
                <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                            <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>
                                                                                             
            <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="ow">and</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                                                                                             
            <span class="k">for</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                                                                                 
                <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                        <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
                <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>
                                                                                                 
                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                     
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                      
                        <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>                    
                    <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>                                                                                  
                    <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
                                                                                                  
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>        

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                              
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                                                  
                    <span class="c1"># Make sure there no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">final_atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span>                   
                                             <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span>  
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                     
      
                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>                                                   
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="n">nm</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">categorical_node_match</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> 
                                <span class="n">nx</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>            
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                                                                                             
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                         <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="k">return</span>

<div class="viewcode-block" id="SystematicPatternGenerator.run"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.SystematicPatternGenerator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_gen_per_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="o">=</span> <span class="n">max_gen_per_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span><span class="p">:</span>                                 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading graphs for existing structures in &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">. This might take a while.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                                                                                   
            <span class="n">prev_images</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">patoms</span> <span class="ow">in</span> <span class="n">prev_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
                <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>      
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                 <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>      
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                    <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>        
                                                                                   
                <span class="n">plabs</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                <span class="n">pG</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plabs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pG</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                   
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generating all possible patterns &#39;</span>
                                   <span class="o">+</span> <span class="s1">&#39;for image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_image</span> <span class="o">=</span> <span class="n">n</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
            <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">)</span>     

            <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nslab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslab</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There is no adsorbate in image </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> 
                                  <span class="o">+</span> <span class="s2">&quot;The only available action is &#39;add&#39;&quot;</span><span class="p">)</span>        
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_adsorbate_enumeration</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_adsorbate_enumeration</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_move_adsorbate_enumeration</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_replace_adsorbate_enumeration</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;label match&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="k">else</span> <span class="s1">&#39;isomorphism&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;All possible patterns were generated &#39;</span>
                                   <span class="o">+</span> <span class="s1">&#39;for image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> patterns were &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;discarded by </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="symmetric_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.symmetric_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">symmetric_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
                               <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                               <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating representative symmetric adsorbate </span>
<span class="sd">    coverage patterns. The function is generalized for both periodic </span>
<span class="sd">    and non-periodic systems (distinguished by atoms.pbc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate : str or ase.Atom object or ase.Atoms object</span>
<span class="sd">        The adsorbate species to be added onto the surface. </span>
<span class="sd">        For now only support adding one type of adsorbate species.</span>

<span class="sd">    coverage : float, default 1. </span>
<span class="sd">        The coverage (ML) of the adsorbate (N_adsorbate / N_surf_atoms). </span>
<span class="sd">        Support 4 coverage patterns (0.25 for p(2x2) pattern; </span>
<span class="sd">        0.5 for c(2x2) pattern on fcc100 or honeycomb pattern on fcc111; </span>
<span class="sd">        0.75 for (2x2) pattern on fcc100 or Kagome pattern on fcc111; </span>
<span class="sd">        1 for p(1x1) pattern.</span>
<span class="sd">        Note that for small nanoparticles, the function might give </span>
<span class="sd">        results that do not correspond to the coverage. This is normal </span>
<span class="sd">        since the surface area can be too small to encompass the </span>
<span class="sd">        coverage pattern properly. We expect this function to work </span>
<span class="sd">        well on large nanoparticles and surface slabs.                  </span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        For now only support 2 common surfaces: fcc100 and fcc111. </span>
<span class="sd">        If the structure is a periodic surface slab, this is required. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    height : float, default None</span>
<span class="sd">        The height of the added adsorbate from the surface.</span>
<span class="sd">        Use the default settings if not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 0.</span>
<span class="sd">        The minimum distance between two atoms that belongs to two </span>
<span class="sd">        adsorbates.</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    To add a 0.5 ML CO coverage pattern on a cuboctahedron:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import symmetric_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Octahedron</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = Octahedron(&#39;Au&#39;, length=9, cutoff=4)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; pattern = symmetric_coverage_pattern(atoms, adsorbate=&#39;CO&#39;, </span>
<span class="sd">        ...                                      coverage=0.5)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    To add a 0.75 ML CO coverage pattern on a fcc111 surface slab:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import symmetric_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import fcc111</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = fcc111(&#39;Cu&#39;, (8, 8, 4), vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center()</span>
<span class="sd">        &gt;&gt;&gt; pattern = symmetric_coverage_pattern(atoms, adsorbate=&#39;CO&#39;,</span>
<span class="sd">        ...                                      coverage=0.5, </span>
<span class="sd">        ...                                      surface=&#39;fcc111&#39;)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                            
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>        
        <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface</span><span class="p">]</span> 

    <span class="c1">#TODO: implement Woods&#39; notation</span>
    <span class="n">final_sites</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;fcc111&#39;</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span> 
        <span class="c1"># p(1x1) pattern</span>
        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> 
                         <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fcc_sites</span><span class="p">:</span>
                <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fcc_sites</span>

        <span class="c1"># Kagome pattern</span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span>  
                         <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fcc_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fcc_sites</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="n">sites_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">:</span>
                        <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">overlap</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> \
                            <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">]:</span>
                                <span class="n">sites_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>                
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">]:</span>
                            <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Honeycomb pattern</span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">]</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="n">fcc_sites</span> <span class="o">+</span> <span class="n">hcp_sites</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>    
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">all_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">all_sites</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>                    
                    <span class="n">sites_to_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                            <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span> \
                            <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">]:</span>
                                <span class="n">sites_to_remain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_remain</span>                                         

            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                       
                <span class="n">bad_sites</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sti</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sti</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">stj</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">stj</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stj</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">sti</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">bad_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sti</span><span class="p">)</span>
                <span class="n">final_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">final_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> \
                               <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">bad_sites</span><span class="p">]]</span>

        <span class="c1"># p(2x2) pattern</span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> 
                         <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>                                                                 
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fcc_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fcc_sites</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="n">sites_to_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">:</span>
                        <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">overlap</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> \
                            <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">]:</span>
                                <span class="n">sites_to_remain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>               
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_remain</span>

    <span class="k">if</span> <span class="s1">&#39;fcc100&#39;</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span>
        <span class="c1"># p(1x1) pattern</span>
        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fold4_sites</span><span class="p">:</span>
                <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fold4_sites</span>

        <span class="c1"># (2x2) pattern </span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                           
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="n">sites_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">:</span>
                        <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>                        
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>                        
                            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>                        
                            <span class="k">if</span> <span class="n">overlap</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> \
                            <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">]:</span>  
                                <span class="n">sites_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                                   <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_delete</span><span class="p">]:</span>
                            <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># c(2x2) pattern</span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
            <span class="n">original_sites</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="n">sites_to_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                            <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">]):</span>
                                <span class="n">sites_to_remain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">]:</span>
                            <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># p(2x2) pattern</span>
        <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                           
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="n">sites_to_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">:</span>
                        <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">overlap</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> \
                            <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remain</span><span class="p">]:</span>  
                                <span class="n">sites_to_remain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_remain</span>

    <span class="c1"># Add edge coverage for nanoparticles</span>
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span> <span class="ow">and</span>
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                               <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> \
                            <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span> \
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>            
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                               <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> \
                            <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span> \
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span> <span class="ow">and</span>
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span> 
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                             <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> \
                             <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span> \
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">nads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">site_heights</span><span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>

        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">min_adsorbate_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">natoms</span><span class="p">:],</span> <span class="n">nads</span><span class="p">,</span>
            <span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span> 
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="n">nads</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">atoms</span></div>


<div class="viewcode-block" id="full_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.full_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">full_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating different p(1x1) adsorbate coverage </span>
<span class="sd">    patterns. The function is generalized for both periodic and </span>
<span class="sd">    non-periodic systems (distinguished by atoms.pbc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate : str or ase.Atom object or ase.Atoms object</span>
<span class="sd">        The adsorbate species to be added onto the surface.</span>
<span class="sd">        For now only support adding one type of adsorbate species.</span>

<span class="sd">    site : str</span>
<span class="sd">        The site type that the adsorbates should be added to.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices). </span>
<span class="sd">        If the structure is a periodic surface slab, this is required. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    height : float, default None</span>
<span class="sd">        The height of the added adsorbate from the surface.</span>
<span class="sd">        Use the default settings if not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 0.</span>
<span class="sd">        The minimum distance between two atoms that belongs to two </span>
<span class="sd">        adsorbates.</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    To add a 1 ML CO coverage pattern to the hcp sites on a icosahedron:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import full_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Icosahedron</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = Icosahedron(&#39;Au&#39;, noshells=5)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; pattern = full_coverage_pattern(atoms, adsorbate=&#39;CO&#39;, site=&#39;hcp&#39;)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    To add a 1 ML CO coverage pattern to the 3fold sites on a bcc110 </span>
<span class="sd">    surface slab:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import full_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import bcc110</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = bcc110(&#39;Mo&#39;, (8, 8, 4), vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center()</span>
<span class="sd">        &gt;&gt;&gt; pattern = full_coverage_pattern(atoms, adsorbate=&#39;CO&#39;,</span>
<span class="sd">        ...                                 surface=&#39;bcc110&#39;, site=&#39;3fold&#39;)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                 
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>        
        <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">,</span>
                                  <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface</span><span class="p">]</span> 

    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">nads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">site_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span> <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">site_heights</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       
            <span class="k">if</span> <span class="n">min_adsorbate_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">natoms</span><span class="p">:],</span> <span class="n">nads</span><span class="p">,</span>
                <span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                    <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="n">nads</span><span class="p">]</span>                               

    <span class="k">return</span> <span class="n">atoms</span></div>


<div class="viewcode-block" id="random_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.patterns.random_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">random_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate_species</span><span class="p">,</span> 
                            <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                            <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
                            <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                            <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating random coverage patterns with a </span>
<span class="sd">    minimum distance constraint. The function is generalized for </span>
<span class="sd">    both periodic and non-periodic systems (distinguished by </span>
<span class="sd">    atoms.pbc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        If the structure is a periodic surface slab, this is required. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        beneath fcc hollow sites.</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    To add CO randomly onto a cuboctahedron with a minimum adsorbate </span>
<span class="sd">    distance of 5 Angstrom:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import random_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Octahedron</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = Octahedron(&#39;Au&#39;, length=9, cutoff=4)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; pattern = random_coverage_pattern(atoms, adsorbate_species=&#39;CO&#39;, </span>
<span class="sd">        ...                                   min_adsorbate_distance=5.)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    To add C, N, O randomly onto a hcp0001 surface slab with probabilities </span>
<span class="sd">    of 0.25, 0.25, 0.5, respectively, and a minimum adsorbate distance of </span>
<span class="sd">    2 Angstrom:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.patterns import random_coverage_pattern</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import hcp0001</span>
<span class="sd">        &gt;&gt;&gt; from ase.visualize import view</span>
<span class="sd">        &gt;&gt;&gt; atoms = hcp0001(&#39;Ru&#39;, (8, 8, 4), vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center()</span>
<span class="sd">        &gt;&gt;&gt; pattern = random_coverage_pattern(atoms, adsorbate_species=[&#39;C&#39;,&#39;N&#39;,&#39;O&#39;],</span>
<span class="sd">        ...                                   species_probabilities={&#39;C&#39;: 0.25, </span>
<span class="sd">        ...                                                          &#39;N&#39;: 0.25, </span>
<span class="sd">        ...                                                          &#39;O&#39;: 0.5},</span>
<span class="sd">        ...                                   surface=&#39;hcp0001&#39;,</span>
<span class="sd">        ...                                   min_adsorbate_distance=2.)</span>
<span class="sd">        &gt;&gt;&gt; view(pattern)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                        <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="n">probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">]</span>               
    
    <span class="n">_heights</span> <span class="o">=</span> <span class="n">site_heights</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">_heights</span>
 
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
        <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">allow_6fold</span><span class="o">=</span><span class="n">allow_6fold</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">,</span>
                                  <span class="n">allow_6fold</span><span class="o">=</span><span class="n">allow_6fold</span><span class="p">)</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>

    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">nads_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ads</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">ads</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">site_list</span><span class="p">:</span>
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">nads</span> <span class="o">=</span> <span class="n">nads_dict</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span> 
        <span class="n">height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">min_adsorbate_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">natoms</span><span class="p">:],</span> <span class="n">nads</span><span class="p">,</span>
            <span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="n">nads</span><span class="p">]</span>                               

    <span class="k">return</span> <span class="n">atoms</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Shuang Han.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>