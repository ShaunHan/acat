

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>acat.build.adlayer &mdash; ACAT 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/table_styling.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/acat_favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ACAT
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Base modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build.html">Building things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ga.html">Evolutionary algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilities.html">Other utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes.html">Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ACAT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>acat.build.adlayer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for acat.build.adlayer</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">..settings</span> <span class="kn">import</span> <span class="p">(</span><span class="n">adsorbate_elements</span><span class="p">,</span> 
                        <span class="n">site_heights</span><span class="p">,</span> 
                        <span class="n">monodentate_adsorbate_list</span><span class="p">,</span> 
                        <span class="n">multidentate_adsorbate_list</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..adsorption_sites</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ClusterAdsorptionSites</span><span class="p">,</span> 
                                <span class="n">SlabAdsorptionSites</span><span class="p">,</span> 
                                <span class="n">group_sites_by_facet</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..adsorbate_coverage</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ClusterAdsorbateCoverage</span><span class="p">,</span> 
                                  <span class="n">SlabAdsorbateCoverage</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_mic</span><span class="p">,</span> 
                         <span class="n">atoms_too_close_after_addition</span><span class="p">,</span> 
                         <span class="n">custom_warning</span><span class="p">,</span> 
                         <span class="n">is_list_or_tuple</span><span class="p">,</span> 
                         <span class="n">numbers_from_ratios</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.action</span> <span class="kn">import</span> <span class="p">(</span><span class="n">add_adsorbate_to_site</span><span class="p">,</span> 
                     <span class="n">remove_adsorbate_from_site</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..ga.graph_comparators</span> <span class="kn">import</span> <span class="n">WLGraphComparator</span>
<span class="kn">from</span> <span class="nn">ase.io</span> <span class="kn">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">Trajectory</span>
<span class="kn">from</span> <span class="nn">ase.formula</span> <span class="kn">import</span> <span class="n">Formula</span>
<span class="kn">from</span> <span class="nn">ase.geometry</span> <span class="kn">import</span> <span class="n">find_mic</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span> <span class="o">=</span> <span class="n">custom_warning</span>


<div class="viewcode-block" id="RandomPatternGenerator"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.RandomPatternGenerator">[docs]</a><span class="k">class</span> <span class="nc">RandomPatternGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`RandomPatternGenerator` is a class for generating adsorbate </span>
<span class="sd">    overlayer patterns stochastically. Graph isomorphism is implemented </span>
<span class="sd">    to identify identical adlayer patterns. 4 adsorbate actions are </span>
<span class="sd">    supported: add, remove, move, replace. The class is generalized for </span>
<span class="sd">    both periodic and non-periodic systems (distinguished by atoms.pbc). </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : ase.Atoms object or list of ase.Atoms objects</span>
<span class="sd">        The structure to perform the adsorbate actions on. </span>
<span class="sd">        If a list of structures is provided, perform one </span>
<span class="sd">        adsorbate action on one of the structures in each step. </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    image_probabilities : listt, default None</span>
<span class="sd">        A list of the probabilities of selecting each structure.</span>
<span class="sd">        Selecting structure with equal probability if not specified.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>
<span class="sd">        Adding adsorbate species with equal probability if not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. Make sure all the structures have the same </span>
<span class="sd">        periodicity and atom indexing. If composition_effect=True, you </span>
<span class="sd">        should only provide adsorption_sites when the surface composition </span>
<span class="sd">        is fixed. If this is not provided, the arguments for identifying</span>
<span class="sd">        adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    subtract_heights : bool, default False</span>
<span class="sd">        Whether to subtract the height from the bond length when allocating</span>
<span class="sd">        a site to an adsorbate. Default is to allocate the site that is</span>
<span class="sd">        closest to the adsorbate&#39;s binding atom without subtracting height.</span>
<span class="sd">        Useful for ensuring the allocated site for each adsorbate is</span>
<span class="sd">        consistent with the site to which the adsorbate was added. </span>

<span class="sd">    dmax : float, default 2.5</span>
<span class="sd">        The maximum bond length (in Angstrom) between an atom and its</span>
<span class="sd">        nearest site to be considered as the atom being bound to the site.</span>

<span class="sd">    species_forbidden_sites : dict, default None                       </span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of the site (can be one or multiple site types) that the </span>
<span class="sd">        speices is not allowed to add to. All sites are availabe for a</span>
<span class="sd">        species if not specified. Note that this does not differentiate</span>
<span class="sd">        sites with different compositions.</span>

<span class="sd">    species_forbidden_labels : dict, default None</span>
<span class="sd">        Same as species_forbidden_sites except that the adsorption sites</span>
<span class="sd">        are written as numerical labels according to acat.labels. Useful</span>
<span class="sd">        when you need to differentiate sites with different compositions.</span>

<span class="sd">    fragmentation : bool, default True                                  </span>
<span class="sd">        Whether to cut multidentate species into fragments. This ensures </span>
<span class="sd">        that multidentate species with different orientations are</span>
<span class="sd">        considered as different adlayer patterns.</span>

<span class="sd">    trajectory : str, default &#39;patterns.traj&#39;</span>
<span class="sd">        The name of the output ase trajectory file.</span>

<span class="sd">    append_trajectory : bool, default False</span>
<span class="sd">        Whether to append structures to the existing trajectory. </span>
<span class="sd">        If only unique patterns are accepted, the code will also check </span>
<span class="sd">        graph isomorphism for the existing structures in the trajectory.</span>
<span class="sd">        This is also useful when you want to generate adlayer patterns </span>
<span class="sd">        stochastically but for all images systematically, e.g. generating</span>
<span class="sd">        10 stochastic adlayer patterns for each image:</span>

<span class="sd">        &gt;&gt;&gt; from acat.build.adlayer import RandomPatternGenerator as RPG</span>
<span class="sd">        &gt;&gt;&gt; for atoms in images:</span>
<span class="sd">        ...    rpg = RPG(atoms, ..., append_trajectory=True)</span>
<span class="sd">        ...    rpg.run(num_gen = 10)</span>

<span class="sd">    logfile : str, default &#39;patterns.log&#39;</span>
<span class="sd">        The name of the log file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>                                                       
                 <span class="n">adsorbate_species</span><span class="p">,</span>
                 <span class="n">image_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                 <span class="n">subtract_heights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dmax</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>                 
                 <span class="n">species_forbidden_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    
                 <span class="n">species_forbidden_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fragmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;patterns.traj&#39;</span><span class="p">,</span>
                 <span class="n">append_trajectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;patterns.log&#39;</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>                     
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                                 <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> 
                                       <span class="n">monodentate_adsorbate_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span>
                                        <span class="n">multidentate_adsorbate_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">-</span> 
                        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;species </span><span class="si">{}</span><span class="s1"> are not defined &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;in adsorbate_list in acat.settings&#39;</span><span class="p">)</span>             

        <span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span> <span class="o">=</span> <span class="n">image_probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="o">=</span> <span class="n">species_probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> 
                                             <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">]</span>               
         
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span> <span class="o">=</span> <span class="n">min_adsorbate_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heights</span> <span class="o">=</span> <span class="n">site_heights</span> 
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">subtract_heights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="kc">None</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allow_6fold&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;composition_effect&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s1">&#39;ignore_bridge_sites&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;label_sites&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>             
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="n">species_forbidden_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="n">species_forbidden_labels</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                             <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span> <span class="o">=</span> <span class="n">fragmentation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="o">=</span> <span class="n">append_trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>      
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
         
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span><span class="p">:</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span> 
                                               <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                                                
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
            <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                    <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>            
                                                                                             
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_species_composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbates_to_add</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">adsorbates_to_add</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                           <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    
                                                                                             
        <span class="c1"># Only add one adsorabte to a site at least 2 shells </span>
        <span class="c1"># away from currently occupied sites</span>
        <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span>
                <span class="n">forb_labs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                   

                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forb_labs</span><span class="p">]</span>    

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nsids</span><span class="p">:</span>                                                             
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to any site. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                                                                             
        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="n">subsurf_site</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nsi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">subsurf_site</span><span class="p">:</span> 
            <span class="n">nsi</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nsids</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
                                                                                             
        <span class="n">nst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>            
        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                                   
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> 
                                       <span class="o">+</span> <span class="s1">&#39;to any site. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>            
                                                                                             
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>                                 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                            

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span> 
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                           
        <span class="c1"># Make sure there is no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">])</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Addition failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">nsac</span>                                                                

    <span class="k">def</span> <span class="nf">_remove_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span> 
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                    
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Removal failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">rmst</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied</span><span class="p">)</span>
        <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> 
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>

        <span class="n">ads_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ads_remain</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Last adsorbate has been removed &#39;</span> <span class="o">+</span> 
                                   <span class="s1">&#39;from image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_image</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                      
        <span class="k">return</span> <span class="n">nsac</span> 

    <span class="k">def</span> <span class="nf">_move_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                         
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>                         
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">rmst</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied</span><span class="p">)</span>
        <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
        <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> 
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>

        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>
                                                                                        
        <span class="c1"># Only add one adsorabte to a site at least 2 shells </span>
        <span class="c1"># away from currently occupied sites</span>
        <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span>
                <span class="n">forb_labs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="k">return</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                   
                                                                                             
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">forb_labs</span><span class="p">]</span>   

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                <span class="n">nsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nsids</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nsids</span><span class="p">:</span>                                                             
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                          
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to place </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;on any other site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                                                                        
        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="n">subsurf_site</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nsi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">subsurf_site</span><span class="p">:</span> 
            <span class="n">nsi</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nsids</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subsurf_site</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">)</span>
                                                                                        
        <span class="n">nst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>            
        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                   
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">nsi</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to place </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> 
                                       <span class="o">+</span> <span class="s1">&#39;on any other site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>
                                                                                        
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span> 
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                          

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                           
        <span class="c1"># Make sure there is no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
        <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The new position of </span><span class="si">{}</span><span class="s1"> is too &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;close to another adsorbate. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The new position of </span><span class="si">{}</span><span class="s1"> is too &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;close to another adsorbate. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
 
        <span class="k">return</span> <span class="n">nsac</span>                                                                 

    <span class="k">def</span> <span class="nf">_replace_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>                     
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                      
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied_stids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsl</span><span class="p">))</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_stids</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">rpsti</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">occupied_stids</span><span class="p">)</span>
        <span class="n">rpst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>
        <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> 
        <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>

        <span class="c1"># Select a different adsorbate with probability </span>
        <span class="n">old_adsorbate</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
        <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_adsorbate</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                         <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                        <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                                                                                                 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                         <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                        <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                                                                                            
                    <span class="k">if</span> <span class="n">lab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                        <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>                                                       

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                      
            <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                        <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>

        <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="ow">and</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">new_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">]</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">new_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 

        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                      
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>                    
            <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not enough space to add </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>  
                                       <span class="o">+</span> <span class="s1">&#39;to any site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span>
                                                                                            
            <span class="c1"># Rotate a bidentate adsorbate to the direction of a randomly </span>
            <span class="c1"># choosed neighbor site</span>
            <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">binbids</span><span class="p">)]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
            <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> 
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                  <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>                     
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span>
                                  <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>                 
 
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>   
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                         <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>         
        <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>                            
                                                                           
        <span class="c1"># Make sure there is no new site too close to previous sites after </span>
        <span class="c1"># the action. Useful when adding large molecules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
        <span class="n">neighbor_site_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">ads_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>                   
                                <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The added </span><span class="si">{}</span><span class="s1"> is too close &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;to another adsorbate. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">nsac</span>                        
 
<div class="viewcode-block" id="RandomPatternGenerator.run"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.RandomPatternGenerator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_gen</span><span class="p">,</span> 
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> 
            <span class="n">action_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">num_act</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">add_species_composition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">hmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">site_preference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">subsurf_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the pattern generator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_gen : int</span>
<span class="sd">            Number of patterns to generate.</span>

<span class="sd">        action : str or list of strs, default &#39;add&#39;</span>
<span class="sd">            Action(s) to perform. If a list of actions is provided, select</span>
<span class="sd">            actions from the list randomly or with probabilities.</span>

<span class="sd">        action_probabilities : dict, default None</span>
<span class="sd">            A dictionary that contains keys of each action and values of the </span>
<span class="sd">            corresponding probabilities. Select actions with equal probability </span>
<span class="sd">            if not specified.</span>

<span class="sd">        num_act : int, default 1</span>
<span class="sd">            Number of times performed for each action. Useful for operating</span>
<span class="sd">            more than one adsorbates at a time. This becomes extremely slow</span>
<span class="sd">            when adding many adsorbates to generate high coverage patterns. </span>
<span class="sd">            The recommended ways to generate high coverage patterns are:</span>
<span class="sd">            1) adding one adsorbate at a time from low to high coverage if </span>
<span class="sd">            you want to control the exact number of adsorbates;</span>
<span class="sd">            2) use `acat.build.adlayer.random_coverage_pattern` if you want</span>
<span class="sd">            to control the minimum adsorbate distance. This is the fastest</span>
<span class="sd">            way, but the number of adsorbates is not guaranteed to be fixed.</span>

<span class="sd">        add_species_composition : dict, default None</span>
<span class="sd">            A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">            values of the species composition to be added onto the surface.</span>
<span class="sd">            Adding adsorbate species according to species_probabilities if </span>
<span class="sd">            not specified. Please only use this if the action is &#39;add&#39;.</span>

<span class="sd">        unique : bool, default False </span>
<span class="sd">            Whether to discard duplicate patterns based on graph isomorphism.</span>
<span class="sd">            The Weisfeiler-Lehman subtree kernel is used to check identity.</span>

<span class="sd">        hmax : int, default 2                                               </span>
<span class="sd">            Maximum number of iterations for color refinement. Only relevant</span>
<span class="sd">            if unique=True.</span>

<span class="sd">        site_preference : str of list of strs, defualt None</span>
<span class="sd">            The site type(s) that has higher priority to attach adsorbates.</span>

<span class="sd">        subsurf_effect : bool, default False</span>
<span class="sd">            Whether to take subsurface atoms into consideration when checking </span>
<span class="sd">            uniqueness. Could be important for surfaces like fcc100.</span>

<span class="sd">        &quot;&quot;&quot;</span>
 
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">action</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_action_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">action_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span> <span class="o">=</span> <span class="n">num_act</span>
        <span class="k">if</span> <span class="n">add_species_composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_species_composition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_species_composition</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">numbers_from_ratios</span><span class="p">(</span><span class="n">num_act</span><span class="p">,</span> <span class="n">ratios</span><span class="p">)</span>
            <span class="n">adsorbates_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="n">ads</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">nums</span><span class="p">)</span> <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">add_species_composition</span> <span class="o">=</span> <span class="n">add_species_composition</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp</span> <span class="o">=</span> <span class="n">WLGraphComparator</span><span class="p">(</span><span class="n">hmax</span><span class="o">=</span><span class="n">hmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span> <span class="o">=</span> <span class="n">subsurf_effect</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span><span class="p">:</span>                                 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading graphs for existing structures in &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">. This might take a while.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">prev_images</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">patoms</span> <span class="ow">in</span> <span class="n">prev_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
                <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> 
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                 <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>           
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                    <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>        

                <span class="n">plabs</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="n">pG</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">,</span>
                                    <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plabs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pG</span><span class="p">)</span>

        <span class="n">n_new</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_old</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Start the iteration</span>
        <span class="k">while</span> <span class="n">n_new</span> <span class="o">&lt;</span> <span class="n">num_gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_species_composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorbates_to_add</span> <span class="o">=</span> <span class="n">adsorbates_to_add</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">n_old</span> <span class="o">==</span> <span class="n">n_new</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generating pattern </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_new</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">n_old</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Select image with probability </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> 
                                            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_image</span> <span class="o">=</span> <span class="n">n_new</span> 

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
            <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>      
            <span class="k">if</span> <span class="n">site_preference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                              
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">site_preference</span><span class="p">):</span>
                    <span class="n">site_preference</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_preference</span><span class="p">]</span>
                <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">site_preference</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Choose an action </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">n_slab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">n_slab</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;add&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>                                                             
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There is no adsorbate in image </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_new</span><span class="p">)</span>
                                  <span class="o">+</span> <span class="s2">&quot;The only available action is &#39;add&#39;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">action_probabilities</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span> 
                                            <span class="n">weights</span><span class="o">=</span><span class="n">all_action_probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Action: </span><span class="si">{0}</span><span class="s1"> x </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">):</span>             
                    <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">):</span>             
                    <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">):</span>             
                    <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">):</span>             
                    <span class="n">nsac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_adsorbate</span><span class="p">(</span><span class="n">sas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nsac</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                    <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">,</span>
                                       <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                        <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span> 
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                        <span class="c1"># If the surface slab is clean, the potentially isomorphic</span>
                        <span class="c1"># graphs are all isomorphic. However, when considering subsurf</span>
                        <span class="c1"># effect, graph isomorphism should still be checked.</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="ow">and</span> <span class="n">potential_graphs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span> <span class="o">==</span> <span class="mi">1</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                              
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Duplicate found by label match. &#39;</span>
                                                   <span class="o">+</span> <span class="s1">&#39;Discarded!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="c1"># Skip duplicates based on isomorphism </span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Duplicate found by isomorphism test. &#39;</span>
                                                   <span class="o">+</span> <span class="s1">&#39;Discarded!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                            <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                          
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>                

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern generated: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>            
            <span class="n">n_new</span> <span class="o">+=</span> <span class="mi">1</span></div></div>


<div class="viewcode-block" id="SystematicPatternGenerator"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.SystematicPatternGenerator">[docs]</a><span class="k">class</span> <span class="nc">SystematicPatternGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`SystematicPatternGenerator` is a class for generating </span>
<span class="sd">    adsorbate overlayer patterns systematically. This is useful to </span>
<span class="sd">    enumerate all unique patterns at low coverage, but explodes at</span>
<span class="sd">    higher coverages. Graph isomorphism is implemented to identify </span>
<span class="sd">    identical adlayer patterns. 4 adsorbate actions are supported: </span>
<span class="sd">    add, remove, move, replace. The class is generalized for both</span>
<span class="sd">    periodic and non-periodic systems (distinguished by atoms.pbc). </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : ase.Atoms object or list of ase.Atoms objects</span>

<span class="sd">        The structure to perform the adsorbate actions on. </span>
<span class="sd">        If a list of structures is provided, perform one </span>
<span class="sd">        adsorbate action on one of the structures in each step. </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. Make sure all the structures have the same </span>
<span class="sd">        periodicity and atom indexing. If composition_effect=True, you </span>
<span class="sd">        should only provide adsorption_sites when the surface composition </span>
<span class="sd">        is fixed. If this is not provided, the arguments for identifying</span>
<span class="sd">        adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    subtract_heights : bool, default False</span>
<span class="sd">        Whether to subtract the height from the bond length when allocating</span>
<span class="sd">        a site to an adsorbate. Default is to allocate the site that is</span>
<span class="sd">        closest to the adsorbate&#39;s binding atom without subtracting height.</span>
<span class="sd">        Useful for ensuring the allocated site for each adsorbate is</span>
<span class="sd">        consistent with the site to which the adsorbate was added. </span>

<span class="sd">    dmax : float, default 2.5</span>
<span class="sd">        The maximum bond length (in Angstrom) between an atom and its</span>
<span class="sd">        nearest site to be considered as the atom being bound to the site.</span>

<span class="sd">    species_forbidden_sites : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of the site (can be one or multiple site types) that the </span>
<span class="sd">        speices is not allowed to add to. All sites are availabe for a</span>
<span class="sd">        species if not specified. Note that this does not differentiate</span>
<span class="sd">        sites with different compositions.</span>

<span class="sd">    species_forbidden_labels : dict, default None</span>
<span class="sd">        Same as species_forbidden_sites except that the adsorption sites</span>
<span class="sd">        are written as numerical labels according to acat.labels. Useful</span>
<span class="sd">        when you need to differentiate sites with different compositions.</span>

<span class="sd">    enumerate_orientations: bool, default True</span>
<span class="sd">        Whether to enumerate all orientations of multidentate species.</span>
<span class="sd">        This ensures that multidentate species with different orientations </span>
<span class="sd">        are all enumerated.</span>

<span class="sd">    trajectory : str, default &#39;patterns.traj&#39;</span>
<span class="sd">        The name of the output ase trajectory file.</span>

<span class="sd">    append_trajectory : bool, default False</span>
<span class="sd">        Whether to append structures to the existing trajectory. </span>
<span class="sd">        If only unique patterns are accepted, the code will also check </span>
<span class="sd">        graph isomorphism for the existing structures in the trajectory.</span>

<span class="sd">    logfile : str, default &#39;patterns.log&#39;</span>
<span class="sd">        The name of the log file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>                                                     
                 <span class="n">adsorbate_species</span><span class="p">,</span>
                 <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                 <span class="n">subtract_heights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dmax</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                 <span class="n">species_forbidden_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">species_forbidden_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">enumerate_orientations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;patterns.traj&#39;</span><span class="p">,</span>
                 <span class="n">append_trajectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;patterns.log&#39;</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>                     
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                                 <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> 
                                       <span class="n">monodentate_adsorbate_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span>
                                        <span class="n">multidentate_adsorbate_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span> <span class="o">-</span> 
                        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monodentate_adsorbates</span> <span class="o">+</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;species </span><span class="si">{}</span><span class="s1"> is not defined &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;in adsorbate_list in acat.settings&#39;</span><span class="p">)</span>             

        <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span> <span class="o">=</span> <span class="n">min_adsorbate_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heights</span> <span class="o">=</span> <span class="n">site_heights</span> 
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">subtract_heights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="kc">None</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allow_6fold&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;composition_effect&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s1">&#39;ignore_bridge_sites&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;label_sites&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>             
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="n">species_forbidden_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="n">species_forbidden_labels</span>
                                                                                           
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                             <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>
                                            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span> <span class="o">=</span> <span class="n">enumerate_orientations</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>                        
        <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="o">=</span> <span class="n">append_trajectory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>                 
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exhaustive_add_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_species_composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbates_to_add</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">act_count</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>        
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                         
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
       
        <span class="c1"># Take care of clean surface slab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span><span class="p">:</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>    
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                            <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                               <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
            <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                    <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
            <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Only add one adsorbate to a site at least 2 shells away from</span>
        <span class="c1"># currently occupied sites</span>
        <span class="n">newsites</span><span class="p">,</span> <span class="n">binbids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                    <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">binbis</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">binbis</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span> 
                    <span class="n">binbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binbis</span><span class="p">)</span>
                <span class="n">newsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newsites</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>                                                                             
                                                                                                     
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                          
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                     
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>
                    <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf sites</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
 
                    <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
  
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>        
 
                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
  
                    <span class="c1"># Make sure there is no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">final_atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span>                   
                                             <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span>
                    <span class="n">adsorbate</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">:</span>                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_add_adsorbate</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
                        <span class="k">return</span>

                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">,</span>
                                               <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="c1"># If the surface slab is clean, the potentially isomorphic</span>
                                <span class="c1"># graphs are all isomorphic. However, when considering subsurf</span>
                                <span class="c1"># effect, graph isomorphism should still be checked.</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="ow">and</span> <span class="n">potential_graphs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span> <span class="o">==</span> <span class="mi">1</span> \
                                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                        <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span> 

    <span class="k">def</span> <span class="nf">_exhaustive_remove_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>                                                           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hsl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Removal failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rmst</span> <span class="ow">in</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                
            <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">rmst</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> 
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">rmst</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>

            <span class="n">ads_remain</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ads_remain</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Last adsorbate has been removed &#39;</span> <span class="o">+</span> 
                                       <span class="s1">&#39;from image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_image</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_remove_adsorbate</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
                <span class="k">return</span>
                                                      
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                             <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>

            <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                    <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">,</span>
                                       <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                        <span class="c1"># Skip duplicates based on isomorphism </span>
                        <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">continue</span>            

                    <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_exhaustive_move_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>                                                           
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>                      
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                            
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>  
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span><span class="p">,</span> <span class="n">occupied</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">occupied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span><span class="p">:</span>                                                       
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Move failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
        <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>

        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">occupied</span><span class="p">:</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                              
            <span class="n">test_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span>
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">test_atoms</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>

            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
 
            <span class="c1"># Only add one adsorabte to a site at least 2 shells away from</span>
            <span class="c1"># currently occupied sites</span>
            <span class="n">newsites</span><span class="p">,</span> <span class="n">binbids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">binbis</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">binbis</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                            <span class="k">continue</span> 
                        <span class="n">binbids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binbis</span><span class="p">)</span>
                    <span class="n">newsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newsites</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">test_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>                                                          

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                          
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>
                    <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf </span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">test_atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                     
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">nst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
      
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">nst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>       

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>   
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
      
                    <span class="c1"># Make sure there is no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">final_atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span>                   
                                             <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>                                                                                   

                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_move_adsorbate</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
                        <span class="k">return</span>

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                      
      
                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">,</span>
                                               <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>            

                            <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                                                                                             
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                        <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_exhaustive_replace_adsorbate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">adsorption_sites</span><span class="p">):</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                           
            <span class="n">sac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                           <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">sac</span><span class="o">.</span><span class="n">hetero_site_list</span>
        <span class="n">occupied_stids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsl</span><span class="p">))</span> <span class="k">if</span> <span class="n">hsl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;occupied&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_stids</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;There is no occupied site. Replacement failed!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>
                                
        <span class="n">rm_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rpsti</span> <span class="ow">in</span> <span class="n">occupied_stids</span><span class="p">:</span>                                                         
            <span class="n">rpst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>
            <span class="n">ads_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate_indices&#39;</span><span class="p">])</span>
            <span class="c1"># Make sure the same adsorbate is not removed twice</span>
            <span class="k">if</span> <span class="n">ads_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rm_ids</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rm_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ads_ids</span><span class="p">)</span>                             
            <span class="n">test_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">rm_frag</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span>  
            <span class="n">remove_adsorbate_from_site</span><span class="p">(</span><span class="n">test_atoms</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="o">=</span><span class="n">rm_frag</span><span class="p">)</span>
                                                                                             
            <span class="c1"># Select a different adsorbate with probability </span>
            <span class="n">old_adsorbate</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;adsorbate&#39;</span><span class="p">]</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">old_adsorbate</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">test_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> 
                                             <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                        
                                                                                                 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sas</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> 
                                             <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
                            <span class="n">lab</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>                            
                        <span class="k">if</span> <span class="n">lab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_labels</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="p">:</span>
                            <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>                                                       

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                      
                <span class="n">_new_options</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_forbidden_sites</span><span class="p">[</span><span class="n">o</span><span class="p">]:</span>
                            <span class="n">_new_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="n">_new_options</span>
                                                                                             
            <span class="c1"># Prohibit adsorbates with more than 1 atom from entering subsurf 6-fold sites</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="ow">and</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">new_options</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                                                                                             
            <span class="k">for</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="n">new_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">site_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_nblist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">site_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                                                                                                 
                <span class="n">nbstids</span><span class="p">,</span> <span class="n">selfids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsl</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]:</span>
                        <span class="n">nbstids</span> <span class="o">+=</span> <span class="n">site_nblist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">selfids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">nbstids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nbstids</span><span class="p">)</span>
                <span class="n">neighbor_site_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nbstids</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selfids</span><span class="p">]</span>
                                                                                                 
                <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>                                     
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                      
                        <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidentate_nblist</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bidentate_nblist</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">binbs</span> <span class="o">=</span> <span class="n">bidentate_nblist</span><span class="p">[</span><span class="n">rpsti</span><span class="p">]</span>                    
                    <span class="n">binbids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">binbs</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbstids</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">binbids</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="n">binbids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">:</span>
                        <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nis</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">nis</span><span class="p">:</span>                                                                                  
                    <span class="n">final_atoms</span> <span class="o">=</span> <span class="n">test_atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">adsorbate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multidentate_adsorbates</span><span class="p">:</span>
                        <span class="c1"># Rotate a multidentate adsorbate to all possible directions of</span>
                        <span class="c1"># a neighbor site</span>
                        <span class="n">nbst</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">nbpos</span> <span class="o">=</span> <span class="n">nbst</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> 
                        <span class="n">orientation</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">nbpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span> 
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]],</span>
                                              <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">)</span>        
                                                                                                  
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">rpst</span><span class="p">,</span>
                                              <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">rpst</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]])</span>        

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                              
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
                    <span class="n">nhsl</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">hetero_site_list</span>
                                                                                                  
                    <span class="c1"># Make sure there is no new site too close to previous sites after </span>
                    <span class="c1"># adding the adsorbate. Useful when adding large molecules</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nhsl</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;occupied&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> 
                    <span class="n">neighbor_site_indices</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">ads_atoms</span> <span class="o">=</span> <span class="n">final_atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_atoms</span> <span class="k">if</span>                   
                                             <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">ads_atoms</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">))),</span>  
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_replace_adsorbate</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
                        <span class="k">return</span>

                    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                     <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                        <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>                     
      
                    <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>                                                   
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>                                        
                        <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">:</span> 
                            <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">,</span>
                                               <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">:</span>
                                <span class="c1"># Skip duplicates based on isomorphism </span>
                                <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">continue</span>            

                            <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>                                       
                        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                                                                                             
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Succeed! Pattern </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_write</span><span class="p">)</span>
                                           <span class="o">+</span> <span class="s1">&#39;generated: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labs</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                        <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">final_atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">final_atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>

<div class="viewcode-block" id="SystematicPatternGenerator.run"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.SystematicPatternGenerator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_gen_per_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span>
            <span class="n">num_act</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">add_species_composition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">hmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">site_preference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">subsurf_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the pattern generator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_gen_per_image : int, default None</span>
<span class="sd">            Maximum number of patterns to generate for each image. Enumerate</span>
<span class="sd">            all possible patterns if not specified.</span>

<span class="sd">        action : str, defualt &#39;add&#39;</span>
<span class="sd">            Action to perform.</span>

<span class="sd">        num_act : int, default 1</span>
<span class="sd">            Number of times performed for the action. Useful for operating</span>
<span class="sd">            more than one adsorbates at a time. This becomes extremely slow</span>
<span class="sd">            when adding many adsorbates to generate high coverage patterns. </span>
<span class="sd">            The recommended way to generate high coverage patterns is to add </span>
<span class="sd">            one adsorbate at a time from low to high coverage if you want to </span>
<span class="sd">            control the exact number of adsorbates.</span>

<span class="sd">        add_species_composition : dict, default None</span>
<span class="sd">            A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">            values of the species composition to be added onto the surface.</span>
<span class="sd">            Adding all possible adsorbate species if not specified. Please </span>
<span class="sd">            only use this if the action is &#39;add&#39;.</span>

<span class="sd">        unique : bool, default False </span>
<span class="sd">            Whether to discard duplicate patterns based on graph isomorphism.</span>
<span class="sd">            The Weisfeiler-Lehman subtree kernel is used to check identity.</span>

<span class="sd">        hmax : int, default 2                                               </span>
<span class="sd">            Maximum number of iterations for color refinement. Only relevant</span>
<span class="sd">            if unique=True.</span>

<span class="sd">        site_preference : str of list of strs, defualt None</span>
<span class="sd">            The site type(s) that has higher priority to attach adsorbates.</span>

<span class="sd">        subsurf_effect : bool, default False</span>
<span class="sd">            Whether to take subsurface atoms into consideration when checking </span>
<span class="sd">            uniqueness. Could be important for surfaces like fcc100.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gen_per_image</span> <span class="o">=</span> <span class="n">max_gen_per_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span> <span class="o">=</span> <span class="n">num_act</span>
        <span class="k">if</span> <span class="n">add_species_composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_species_composition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_species_composition</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">numbers_from_ratios</span><span class="p">(</span><span class="n">num_act</span><span class="p">,</span> <span class="n">ratios</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorbates_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="n">ads</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">nums</span><span class="p">)</span> <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">add_species_composition</span> <span class="o">=</span> <span class="n">add_species_composition</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">act_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_write</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp</span> <span class="o">=</span> <span class="n">WLGraphComparator</span><span class="p">(</span><span class="n">hmax</span><span class="o">=</span><span class="n">hmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span> <span class="o">=</span> <span class="n">subsurf_effect</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span><span class="p">:</span>                                 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                             
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Loading graphs for existing structures in &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">. This might take a while.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                                                                                   
            <span class="n">prev_images</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">patoms</span> <span class="ow">in</span> <span class="n">prev_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
                <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>      
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">patoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                 <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>      
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">psas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">,</span>
                                                    <span class="n">label_occupied_sites</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>        
                                                                                   
                <span class="n">plabs</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">)</span>
                <span class="n">pG</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enumerate_orientations</span><span class="p">,</span>
                                    <span class="n">subsurf_effect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_effect</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plabs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pG</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_write_per_image</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                   
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generating all possible patterns &#39;</span>
                                   <span class="o">+</span> <span class="s1">&#39;for image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_image</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
            <span class="k">elif</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;please specify the surface type&#39;</span><span class="p">)</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>     
            <span class="k">if</span> <span class="n">site_preference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                              
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">site_preference</span><span class="p">):</span>
                    <span class="n">site_preference</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_preference</span><span class="p">]</span>
                <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">site_preference</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_slab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_slab</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There is no adsorbate in image </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> 
                                  <span class="o">+</span> <span class="s2">&quot;The only available action is &#39;add&#39;&quot;</span><span class="p">)</span>        
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                    
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Action: </span><span class="si">{0}</span><span class="s1"> x </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_act</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_add_adsorbate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_remove_adsorbate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_move_adsorbate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exhaustive_replace_adsorbate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">)</span>            

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;label match&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_slab</span> <span class="k">else</span> <span class="s1">&#39;isomorphism test&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;All possible patterns were generated &#39;</span>
                                   <span class="o">+</span> <span class="s1">&#39;for image </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> patterns were &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_duplicate</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="s1">&#39;discarded by </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="OrderedPatternGenerator"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.OrderedPatternGenerator">[docs]</a><span class="k">class</span> <span class="nc">OrderedPatternGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`OrderedPatternGenerator` is a class for generating </span>
<span class="sd">    adsorbate overlayer patterns stochastically. Graph isomorphism</span>
<span class="sd">    is implemented to identify identical adlayer patterns. 4 </span>
<span class="sd">    adsorbate actions are supported: add, remove, move, replace. </span>
<span class="sd">    The class is generalized for both periodic and non-periodic </span>
<span class="sd">    systems (distinguished by atoms.pbc). </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : ase.Atoms object or list of ase.Atoms objects</span>
<span class="sd">        The structure to perform the adsorbate actions on. </span>
<span class="sd">        If a list of structures is provided, perform one </span>
<span class="sd">        adsorbate action on one of the structures in each step. </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of possible adsorbate species to be added to the surface.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and</span>
<span class="sd">        values of their probabilities of adding onto the surface.    </span>

<span class="sd">    repeating_distance : float, default None</span>
<span class="sd">        The pairwise distance (in Angstrom) between two symmetry-equivalent </span>
<span class="sd">        adsorption sites. If repeating_distance is not provided, all</span>
<span class="sd">        possible repeating distances are considered.</span>

<span class="sd">    max_species : int, default None</span>
<span class="sd">        The maximum allowed adsorbate species (excluding vacancies) for a </span>
<span class="sd">        single structure. Allow all adsorbatae species if not specified.</span>

<span class="sd">    sorting_vector : numpy.array, default numpy.array([1, 0])</span>
<span class="sd">        The 2D (or 3D) vector [x, y] represeting the vertical plane to </span>
<span class="sd">        sort the sites based on the signed distance from the site to that </span>
<span class="sd">        plane before grouping. Use the x-axis by default. Recommend using </span>
<span class="sd">        default or the diagonal vector.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. Make sure all the structures have the same </span>
<span class="sd">        periodicity and atom indexing. If composition_effect=True, you </span>
<span class="sd">        should only provide adsorption_sites when the surface composition </span>
<span class="sd">        is fixed. If this is not provided, the arguments for identifying</span>
<span class="sd">        adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    remove_site_shells : int, default 1                                    </span>
<span class="sd">        The neighbor shell number within which the neighbor sites should be </span>
<span class="sd">        removed. Remove the 1st neighbor site shell by default. Set to 0 if</span>
<span class="sd">        no site should be removed.</span>

<span class="sd">    remove_site_radius : float, default None                                  </span>
<span class="sd">        The radius within which the neighbor sites should be removed. This </span>
<span class="sd">        serves as an alternative to remove_site_shells.                   </span>

<span class="sd">    populate_isolated_sites : bool, default False</span>
<span class="sd">        Whether to add adsorbates to low-symmetry sites that are not grouped </span>
<span class="sd">        with any other sites.</span>

<span class="sd">    allow_odd : bool, default False</span>
<span class="sd">        Whether to allow odd number of adsorbates. This is done by singling</span>
<span class="sd">        out one site for each symmetry-inequivalent site.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    subtract_heights : bool, default False</span>
<span class="sd">        Whether to subtract the height from the bond length when allocating</span>
<span class="sd">        a site to an adsorbate. Default is to allocate the site that is</span>
<span class="sd">        closest to the adsorbate&#39;s binding atom without subtracting height.</span>
<span class="sd">        Useful for ensuring the allocated site for each adsorbate is</span>
<span class="sd">        consistent with the site to which the adsorbate was added.         </span>

<span class="sd">    site_groups : list of lists, default None                                 </span>
<span class="sd">        Provide the user defined symmetry equivalent site groups as a list </span>
<span class="sd">        of lists of site indices (of the site list). Useful for generating </span>
<span class="sd">        structures with symmetries that are not supported.</span>

<span class="sd">    save_groups : bool, default False</span>
<span class="sd">        Whether to save the site groups in atoms.info[&#39;data&#39;][&#39;groups&#39;] for</span>
<span class="sd">        each generated structure. If there is groups present (e.g. the groups </span>
<span class="sd">        of the slab atoms), append the site groups to it.</span>

<span class="sd">    fragmentation : bool, default True                                  </span>
<span class="sd">        Whether to cut multidentate species into fragments. This ensures</span>
<span class="sd">        that multidentate species with different orientations are</span>
<span class="sd">        considered as different adlayer patterns.</span>

<span class="sd">    dmax : float, default 2.5</span>
<span class="sd">        The maximum bond length (in Angstrom) between an atom and its</span>
<span class="sd">        nearest site to be considered as the atom being bound to the site.</span>

<span class="sd">    dtol : float, default 0.3</span>
<span class="sd">        The tolerance (in Angstrom) when calculating the repeating distance.</span>

<span class="sd">    trajectory : str, default &#39;patterns.traj&#39;</span>
<span class="sd">        The name of the output ase trajectory file.</span>

<span class="sd">    append_trajectory : bool, default False</span>
<span class="sd">        Whether to append structures to the existing trajectory. </span>
<span class="sd">        If only unique patterns are accepted, the code will also check </span>
<span class="sd">        graph isomorphism for the existing structures in the trajectory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> 
                 <span class="n">adsorbate_species</span><span class="p">,</span> 
                 <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">repeating_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sorting_vector</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> 
                 <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">remove_site_shells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">remove_site_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">populate_isolated_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">allow_odd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span> 
                 <span class="n">subtract_heights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">site_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">save_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">fragmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dmax</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                 <span class="n">dtol</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span>
                 <span class="n">trajectory</span><span class="o">=</span><span class="s1">&#39;patterns.traj&#39;</span><span class="p">,</span>
                 <span class="n">append_trajectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>                     
        <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                                 <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="o">=</span> <span class="n">species_probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> 
                                             <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">]</span>               
        <span class="bp">self</span><span class="o">.</span><span class="n">repeating_distance</span> <span class="o">=</span> <span class="n">repeating_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allow_6fold&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;composition_effect&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s1">&#39;ignore_bridge_sites&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;label_sites&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>             
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sorting_vector</span> <span class="o">=</span> <span class="n">sorting_vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heights</span> <span class="o">=</span> <span class="n">site_heights</span> 
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">subtract_heights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span> <span class="o">=</span> <span class="kc">None</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_site_shells</span> <span class="o">=</span> <span class="n">remove_site_shells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_site_radius</span> <span class="o">=</span> <span class="n">remove_site_radius</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_shells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">get_neighbor_site_list</span><span class="p">(</span>
                       <span class="n">neighbor_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_shells</span><span class="p">,</span>
                       <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_isolated_sites</span> <span class="o">=</span> <span class="n">populate_isolated_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_odd</span> <span class="o">=</span> <span class="n">allow_odd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_groups</span> <span class="o">=</span> <span class="n">save_groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span> <span class="o">=</span> <span class="n">fragmentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtol</span> <span class="o">=</span> <span class="n">dtol</span>

        <span class="k">if</span> <span class="n">max_species</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_species</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">))</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">max_species</span> <span class="o">=</span> <span class="n">max_species</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="o">=</span> <span class="n">append_trajectory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">site_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                  
            <span class="bp">self</span><span class="o">.</span><span class="n">site_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_site_groups</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_groups</span> <span class="o">=</span> <span class="n">site_groups</span>

<div class="viewcode-block" id="OrderedPatternGenerator.get_site_groups"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.OrderedPatternGenerator.get_site_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_all_site_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the groups (a list of lists of site indices) of all</span>
<span class="sd">        pairs of symmetry-equivalent sites.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_all_site_groups : bool, default False</span>
<span class="sd">            Whether to return all possible high-symmetry groupings of </span>
<span class="sd">            the adsorption sites.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorting_vector</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_odd</span><span class="p">:</span>
            <span class="n">seen_labs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">odd_site_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_labs</span><span class="p">:</span>
                    <span class="n">odd_site_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">seen_labs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">])</span>
        <span class="n">pt0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_signed_distance</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">pt0</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cross</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="p">(</span><span class="n">cross</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">dist</span>

        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                <span class="n">get_signed_distance</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]))</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indices</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pt1</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">find_mic</span><span class="p">(</span><span class="n">pts</span> <span class="o">-</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                           <span class="n">pbc</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeating_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">lengths</span><span class="p">())</span> 
                <span class="n">i2a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lmax</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i2a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeating_distance</span><span class="p">)</span> 
                                  <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtol</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i2a</span><span class="p">:</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="n">all_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="n">i2a</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_shells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsl</span><span class="p">[</span><span class="n">i1</span><span class="p">]:</span>
                    <span class="k">continue</span>
            <span class="n">pt2</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="n">i2</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i2</span><span class="p">]</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">}</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">([</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
                <span class="n">repeat_pt</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">+</span> <span class="n">vec</span>
                <span class="n">dists</span> <span class="o">=</span> <span class="n">find_mic</span><span class="p">(</span><span class="n">pts</span> <span class="o">-</span> <span class="n">repeat_pt</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                 <span class="n">pbc</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ja</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">dists</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtol</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ja</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_isolated_sites</span><span class="p">:</span>
                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ja</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dists</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">//</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populate_isolated_sites</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_odd</span><span class="p">:</span>
                    <span class="n">new_groups</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">odd_site_indices</span><span class="p">)):</span>
                            <span class="n">new_groups</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="n">groups</span> <span class="o">=</span> <span class="n">new_groups</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">return_all_site_groups</span><span class="p">:</span>
                    <span class="n">groups</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">)</span>
                    <span class="n">all_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">groups</span>

        <span class="n">all_sorted_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">groups</span> <span class="ow">in</span> <span class="n">all_groups</span><span class="p">:</span>
            <span class="n">sorted_groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
            <span class="n">all_sorted_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_groups</span><span class="p">)</span>
 
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_sorted_groups</span><span class="p">)</span></div>
 
<div class="viewcode-block" id="OrderedPatternGenerator.run"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.OrderedPatternGenerator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_gen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the ordered pattern generator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_gen : int, default None</span>
<span class="sd">            Maximum number of chemical orderings to generate. Running</span>
<span class="sd">            forever (until exhaustive for systematic search) if not </span>
<span class="sd">            specified. </span>

<span class="sd">        unique : bool, default False </span>
<span class="sd">            Whether to discard duplicate patterns based on graph isomorphism.</span>
<span class="sd">            The Weisfeiler-Lehman subtree kernel is used to check identity.</span>

<span class="sd">        hmax : int, default 2                                               </span>
<span class="sd">            Maximum number of iterations for color refinement. Only relevant</span>
<span class="sd">            if unique=True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">traj_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">traj_mode</span><span class="p">)</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_sites</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_groups</span>        
        <span class="n">ngroups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">labels_list</span><span class="p">,</span> <span class="n">graph_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">WLGraphComparator</span><span class="p">(</span><span class="n">hmax</span><span class="o">=</span><span class="n">hmax</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_trajectory</span><span class="p">:</span>                                
            <span class="n">prev_images</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">patoms</span> <span class="ow">in</span> <span class="n">prev_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">patoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">)</span>
                <span class="n">plabs</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="n">pG</span> <span class="o">=</span> <span class="n">psac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                <span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plabs</span><span class="p">)</span>
                <span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pG</span><span class="p">)</span>

        <span class="n">n_write</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">combos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">too_few</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">ngroups</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">&lt;=</span> <span class="n">max_gen</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_probabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">specs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_species</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;vacancy&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_species</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adsorbate_species</span><span class="p">,</span>                  
                                       <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_probability_list</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;vacancy&#39;</span><span class="p">]</span>  
            <span class="n">combo</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ngroups</span>                                 
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ngroups</span><span class="p">))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">newvs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">newvs</span><span class="p">):</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;vacancy&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_shells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_site_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">spec</span> <span class="o">!=</span> <span class="s1">&#39;vacancy&#39;</span><span class="p">):</span>
                        <span class="n">newvs</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">group</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsl</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                <span class="n">combo</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

            <span class="n">combo</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="s1">&#39;vacancy&#39;</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">combo</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">combo</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combos</span> <span class="ow">or</span> <span class="n">too_few</span><span class="p">:</span>
                    <span class="n">atoms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dup</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combo</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;vacancy&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">sl</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heights</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
                            <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                                <span class="n">nsac</span> <span class="o">=</span> <span class="n">SlabAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">)</span> 
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nsac</span> <span class="o">=</span> <span class="n">ClusterAdsorbateCoverage</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">subtract_heights</span><span class="o">=</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">subtract_heights</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">)</span>     
                            <span class="n">labs</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_occupied_labels</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">labs</span> <span class="ow">in</span> <span class="n">labels_list</span><span class="p">:</span>
                                <span class="n">G</span> <span class="o">=</span> <span class="n">nsac</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">fragmentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fragmentation</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">graph_list</span><span class="p">:</span>
                                    <span class="c1"># Skip duplicates based on isomorphism </span>
                                    <span class="n">potential_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph_list</span><span class="p">)</span> 
                                                        <span class="k">if</span> <span class="n">labels_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labs</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">H</span> <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">potential_graphs</span> <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">looks_like</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">)):</span>
                                        <span class="n">dup</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                <span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
                            <span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dup</span><span class="p">:</span>
                        <span class="k">continue</span>                   
                    <span class="n">combos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_groups</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                            <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="s1">&#39;groups&#39;</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                            <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">groups</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atoms</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups</span>
                    <span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">n_write</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">max_gen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n_write</span> <span class="o">==</span> <span class="n">max_gen</span><span class="p">:</span>
                            <span class="k">break</span></div></div>


<div class="viewcode-block" id="special_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.special_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">special_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate_species</span><span class="p">,</span> 
                             <span class="n">coverage</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
                             <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                             <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                             <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating representative ordered adsorbate </span>
<span class="sd">    overlayer patterns. The function is generalized for both periodic </span>
<span class="sd">    and non-periodic systems (distinguished by atoms.pbc). Note that</span>
<span class="sd">    the algorithm currently does not work for orthogonal fcc111 cells.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be added to the surface.</span>

<span class="sd">    coverage : float, default 1. </span>
<span class="sd">        The coverage (ML) of the adsorbate (N_adsorbate / N_surf_atoms). </span>
<span class="sd">        Support 4 adlayer patterns (</span>
<span class="sd">        0.25 for p(2x2) pattern; </span>
<span class="sd">        0.5 for c(2x2) pattern on fcc100 or honeycomb pattern on fcc111; </span>
<span class="sd">        0.75 for (2x2) pattern on fcc100 or Kagome pattern on fcc111; </span>
<span class="sd">        1. for p(1x1) pattern; </span>
<span class="sd">        2. for ontop+4fold pattern on fcc100 or fcc+hcp pattern on fcc111.</span>
<span class="sd">        Note that for small nanoparticles, the function might give </span>
<span class="sd">        results that do not correspond to the coverage. This is normal </span>
<span class="sd">        since the surface area can be too small to encompass the </span>
<span class="sd">        adlayer pattern properly. We expect this function to work </span>
<span class="sd">        well on large nanoparticles and surface slabs.                  </span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. If this is not provided, the arguments for </span>
<span class="sd">        identifying adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        For now only support 2 common surfaces: fcc100 and fcc111. </span>
<span class="sd">        If the structure is a periodic surface slab, this is required when</span>
<span class="sd">        adsorption_sites is not provided. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    height : float, default None</span>
<span class="sd">        The height of the added adsorbate from the surface.</span>
<span class="sd">        Use the default settings if not specified.</span>

<span class="sd">    min_adsorbate_distance : float, default 0.</span>
<span class="sd">        The minimum distance between two atoms that belongs to two </span>
<span class="sd">        adsorbates.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">coverage</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="s1">&#39;coverage not supported&#39;</span> 

    <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>                                     
                        <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="n">probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">]</span>

    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                            
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>       
            <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="s1">&#39;both_sides&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;both_sides&#39;</span><span class="p">]:</span>
                <span class="n">bot_site_list</span> <span class="o">=</span> <span class="n">site_list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">site_list</span> <span class="o">=</span> <span class="n">site_list</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface</span><span class="p">]</span> 

    <span class="c1">#TODO: implement Woods&#39; notation</span>
    <span class="k">def</span> <span class="nf">find_special_sites</span><span class="p">(</span><span class="n">site_list</span><span class="p">):</span>
        <span class="n">final_sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;fcc111&#39;</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span> 
            <span class="c1"># fcc+hcp pattern</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fold3_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc&#39;</span><span class="p">,</span> <span class="s1">&#39;hcp&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">fold3_sites</span><span class="p">:</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fold3_sites</span>

            <span class="c1"># p(1x1) pattern</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fcc_sites</span><span class="p">:</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fcc_sites</span>
 
            <span class="c1"># Kagome pattern</span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fcc_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fcc_sites</span><span class="p">}</span>

                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="n">sites_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">:</span>
                            <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                    <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                                <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                                <span class="k">if</span> <span class="n">overlap</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">]:</span>
                                    <span class="n">sites_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_remove</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                   <span class="mi">1</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">):]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">]:</span>
                                <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
            <span class="c1"># Honeycomb pattern</span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>
                <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">]</span>
                <span class="n">all_sites</span> <span class="o">=</span> <span class="n">fcc_sites</span> <span class="o">+</span> <span class="n">hcp_sites</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>    
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">all_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">all_sites</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>                    
                        <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span> \
                                <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> \
                                <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">]:</span>
                                    <span class="n">sites_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_keep</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">all_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                 <span class="mi">1</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">):]</span>
                        <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_keep</span>                                          
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                                                       
                    <span class="n">bad_sites</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">sti</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sti</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">stj</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">stj</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stj</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sti</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">bad_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sti</span><span class="p">)</span>
                    <span class="n">final_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">final_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> 
                                   <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">bad_sites</span><span class="p">]]</span>
 
            <span class="c1"># p(2x2) pattern</span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fcc_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">]</span>                                                                 
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fcc_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fcc_sites</span><span class="p">}</span>
 
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">:</span>
                            <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                    <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                                <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                                <span class="k">if</span> <span class="n">overlap</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">]:</span>
                                    <span class="n">sites_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>               
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_keep</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                 <span class="mi">1</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fcc_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">):]</span>
                        <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_keep</span>
 
        <span class="k">if</span> <span class="s1">&#39;fcc100&#39;</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span>
            <span class="c1"># ontop+4fold pattern</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fold14_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ontop&#39;</span><span class="p">,</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">fold14_sites</span><span class="p">:</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fold14_sites</span>

            <span class="c1"># p(1x1) pattern</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fold4_sites</span><span class="p">:</span>
                    <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">fold4_sites</span>
 
            <span class="c1"># (2x2) pattern </span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                           
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="n">sites_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">:</span>
                            <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                    <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>                        
                                <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>                        
                                <span class="k">if</span> <span class="n">overlap</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">]:</span>  
                                    <span class="n">sites_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_remove</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sorted_sites</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                   <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
                                                   <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_remove</span><span class="p">]:</span>
                                <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
            <span class="c1"># c(2x2) pattern</span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
                <span class="n">original_sites</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> \
                                <span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> 
                                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">]):</span>
                                    <span class="n">sites_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_keep</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sorted_sites</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                 <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                                                 <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">original_sites</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">]:</span>
                                <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 
            <span class="c1"># p(2x2) pattern</span>
            <span class="k">elif</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">fold4_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                           
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">fold4_sites</span><span class="p">,</span> <span class="n">site_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pbc_sites&#39;</span><span class="p">:</span> <span class="n">fold4_sites</span><span class="p">}</span>

                <span class="k">for</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">grouped_sites</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sites</span><span class="p">:</span>
                        <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">sitei</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">:</span>
                            <span class="n">common_site_indices</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">non_common_sites</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">sitei</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]):</span>
                                    <span class="n">common_site_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">non_common_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">sitej</span> <span class="ow">in</span> <span class="n">non_common_sites</span><span class="p">:</span>
                                <span class="n">overlap</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">common_site_indices</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
                                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]])</span>
                                <span class="k">if</span> <span class="n">overlap</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sitej</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_to_keep</span><span class="p">]:</span>  
                                    <span class="n">sites_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sitej</span><span class="p">)</span>
                        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_to_keep</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
                                <span class="n">sorted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                                      <span class="n">x</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">sites_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">sorted_sites</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">sorted_sites</span><span class="p">[</span>
                                                 <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">):</span>
                                                 <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_sites</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">sites_to_keep</span>
        <span class="k">return</span> <span class="n">final_sites</span>

    <span class="n">final_sites</span> <span class="o">=</span> <span class="n">find_special_sites</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;both_sides&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;both_sides&#39;</span><span class="p">]:</span>
                <span class="n">final_sites</span> <span class="o">+=</span> <span class="n">find_special_sites</span><span class="p">(</span><span class="n">bot_site_list</span><span class="p">)</span>
    <span class="c1"># Add edge coverage for nanoparticles</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coverage</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span> <span class="ow">and</span>
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span>
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>            
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span> <span class="ow">and</span>
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span>
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coverage</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">occupied_sites</span> <span class="o">=</span> <span class="n">final_sites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hcp_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span> <span class="ow">and</span>
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">]</span>
            <span class="n">edge_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> 
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">and</span>
                          <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">vertex_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> 
                              <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span>
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                              <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vertex&#39;</span><span class="p">]</span> 
            <span class="n">ve_common_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vertex_indices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertex_indices</span><span class="p">:</span>
                            <span class="n">ve_common_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">esite</span> <span class="ow">in</span> <span class="n">edge_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span>
                <span class="n">ve_common_indices</span><span class="p">):</span>
                    <span class="n">intermediate_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hsite</span> <span class="ow">in</span> <span class="n">hcp_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">intermediate_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">hsite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span>
                    <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">intermediate_indices</span><span class="p">:</span>
                        <span class="n">share</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span> <span class="k">if</span>
                                          <span class="n">interi</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]]))</span>
                    <span class="n">too_close</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">occupied_sites</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">esite</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">too_close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">too_close</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">final_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esite</span><span class="p">)</span>

    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">nads_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ads</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">ads</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="n">nads</span> <span class="o">=</span> <span class="n">nads_dict</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">site_heights</span><span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">min_adsorbate_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">natoms</span><span class="p">:],</span> <span class="n">nads</span><span class="p">,</span>
            <span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span> 
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="n">nads</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">atoms</span></div>


<div class="viewcode-block" id="max_dist_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.max_dist_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">max_dist_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate_species</span><span class="p">,</span> 
                              <span class="n">coverage</span><span class="p">,</span> <span class="n">site_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                              <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating random adlayer patterns with </span>
<span class="sd">    a certain surface adsorbate coverage (i.e. fixed number of </span>
<span class="sd">    adsorbates N) and trying to even the adsorbate density. The </span>
<span class="sd">    function samples N sites from all given sites using K-medoids </span>
<span class="sd">    clustering to maximize the minimum distance between sites and </span>
<span class="sd">    add N adsorbates to these sites. The function is generalized </span>
<span class="sd">    for both periodic and non-periodic systems (distinguished by </span>
<span class="sd">    atoms.pbc). pyclustering is required.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be added to the surface.</span>

<span class="sd">    coverage : float</span>
<span class="sd">        The surface coverage calculated by (number of adsorbates /</span>
<span class="sd">        number of surface atoms). Subsurface sites are not considered.</span>

<span class="sd">    site_types : str or list of strs, default None</span>
<span class="sd">        The site type(s) that the adsorbates should be added to.</span>
<span class="sd">        Consider all sites if not specified.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. If this is not provided, the arguments for </span>
<span class="sd">        identifying adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices). </span>
<span class="sd">        If the structure is a periodic surface slab, this is required when</span>
<span class="sd">        adsorption_sites is not provided. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyclustering.cluster.kmedoids</span> <span class="kn">import</span> <span class="n">kmedoids</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                        <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">site_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">site_types</span> <span class="o">=</span> <span class="n">site_types</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">site_types</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">site_types</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="n">probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">]</span>               
    
    <span class="n">_heights</span> <span class="o">=</span> <span class="n">site_heights</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">_heights</span>
 
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">surface</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">if</span> <span class="n">site_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">site_types</span> 
                     <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;6fold&#39;</span><span class="p">]</span>

    <span class="n">nads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">)</span> <span class="o">*</span> <span class="n">coverage</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span><span class="p">])</span>
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">find_mic</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span> 
                        <span class="n">cell</span><span class="o">=</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>

    <span class="c1"># K-medoids clustering (PAM algorithm)</span>
    <span class="n">medoids_init</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)),</span> <span class="n">nads</span><span class="p">)</span>
    <span class="n">pam</span> <span class="o">=</span> <span class="n">kmedoids</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">medoids_init</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;distance_matrix&#39;</span><span class="p">)</span>
    <span class="n">pam</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
    <span class="n">sampled_indices</span> <span class="o">=</span> <span class="n">pam</span><span class="o">.</span><span class="n">get_medoids</span><span class="p">()</span>

    <span class="n">final_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sampled_indices</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_sites</span><span class="p">:</span>
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="n">height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       

    <span class="k">return</span> <span class="n">atoms</span></div>


<div class="viewcode-block" id="min_dist_coverage_pattern"><a class="viewcode-back" href="../../../build.html#acat.build.adlayer.min_dist_coverage_pattern">[docs]</a><span class="k">def</span> <span class="nf">min_dist_coverage_pattern</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate_species</span><span class="p">,</span> 
                              <span class="n">species_probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">adsorption_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                              <span class="n">min_adsorbate_distance</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
                              <span class="n">site_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">heights</span><span class="o">=</span><span class="n">site_heights</span><span class="p">,</span>
                              <span class="n">site_preference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function for generating random adlayer patterns with a </span>
<span class="sd">    minimum distance constraint and trying to maximize the adsorbate</span>
<span class="sd">    density. The function is generalized for both periodic and </span>
<span class="sd">    non-periodic systems (distinguished by atoms.pbc). Especially </span>
<span class="sd">    useful for generating high coverage patterns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The nanoparticle or surface slab onto which the adsorbates are</span>
<span class="sd">        added. Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    adsorbate_species : str or list of strs </span>
<span class="sd">        A list of adsorbate species to be randomly added to the surface.</span>

<span class="sd">    species_probabilities : dict, default None</span>
<span class="sd">        A dictionary that contains keys of each adsorbate species and </span>
<span class="sd">        values of their probabilities of adding onto the surface.</span>

<span class="sd">    adsorption_sites : acat.adsorption_sites.ClusterAdsorptionSites object \</span>
<span class="sd">        or acat.adsorption_sites.SlabAdsorptionSites object, default None</span>
<span class="sd">        Provide the built-in adsorption sites class to accelerate the </span>
<span class="sd">        pattern generation. If this is not provided, the arguments for </span>
<span class="sd">        identifying adsorption sites can still be passed in by **kwargs.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        If the structure is a periodic surface slab, this is required when</span>
<span class="sd">        adsorption_sites is not provided. </span>
<span class="sd">        If the structure is a nanoparticle, the function only add </span>
<span class="sd">        adsorbates to the sites on the specified surface. </span>

<span class="sd">    min_adsorbate_distance : float, default 1.5</span>
<span class="sd">        The minimum distance constraint between two atoms that belongs </span>
<span class="sd">        to two adsorbates.</span>

<span class="sd">    site_types : str or list of strs, default None</span>
<span class="sd">        The site type(s) that the adsorbates should be added to.</span>
<span class="sd">        Consider all sites if not specified.</span>

<span class="sd">    heights : dict, default acat.settings.site_heights</span>
<span class="sd">        A dictionary that contains the adsorbate height for each site </span>
<span class="sd">        type. Use the default height settings if the height for a site </span>
<span class="sd">        type is not specified.</span>

<span class="sd">    site_preference : str of list of strs, defualt None</span>
<span class="sd">        The site type(s) that has higher priority to attach adsorbates.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adsorbate_species</span> <span class="o">=</span> <span class="n">adsorbate_species</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span>
                        <span class="n">adsorbate_species</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">adsorbate_species</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">site_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">site_types</span> <span class="o">=</span> <span class="n">site_types</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">site_types</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">site_types</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">species_probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_probabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="n">probability_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">species_probabilities</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">]</span>               
    
    <span class="n">_heights</span> <span class="o">=</span> <span class="n">site_heights</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_heights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">_heights</span>
 
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>                                
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">surface</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adsorption_sites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                           
            <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sas</span> <span class="o">=</span> <span class="n">adsorption_sites</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="k">if</span> <span class="n">site_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">site_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">site_list</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">site_types</span><span class="p">]</span>

    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">nads_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ads</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">ads</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="n">adsorbate_species</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">site_preference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">site_preference</span><span class="p">):</span>
            <span class="n">site_preference</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_preference</span><span class="p">]</span>
        <span class="n">site_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">site_preference</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">site_list</span><span class="p">:</span>
        <span class="c1"># Select adsorbate with probability </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">species_probabilities</span><span class="p">:</span>
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adsorbate_species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">adsorbate_species</span><span class="p">,</span>
                                       <span class="n">weights</span><span class="o">=</span><span class="n">probability_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6fold&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">nads</span> <span class="o">=</span> <span class="n">nads_dict</span><span class="p">[</span><span class="n">adsorbate</span><span class="p">]</span> 
        <span class="n">height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
        <span class="n">add_adsorbate_to_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">min_adsorbate_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atoms_too_close_after_addition</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">natoms</span><span class="p">:],</span> <span class="n">nads</span><span class="p">,</span>
            <span class="n">min_adsorbate_distance</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">)):</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[:</span><span class="o">-</span><span class="n">nads</span><span class="p">]</span>                               

    <span class="k">return</span> <span class="n">atoms</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Shuang Han.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>