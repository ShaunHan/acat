

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>acat.adsorption_sites &mdash; ACAT 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/table_styling.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/acat_favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ACAT
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Base modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build.html">Building things</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ga.html">Genetic algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Other utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes.html">Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ACAT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>acat.adsorption_sites</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for acat.adsorption_sites</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">adsorbate_elements</span><span class="p">,</span> <span class="n">site_heights</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">expand_cell</span><span class="p">,</span> <span class="n">get_mic</span> 
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">is_list_or_tuple</span><span class="p">,</span> <span class="n">get_max_delta_sum_path</span>  
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">neighbor_shell_list</span><span class="p">,</span> <span class="n">get_connectivity_matrix</span>
<span class="kn">from</span> <span class="nn">.labels</span> <span class="kn">import</span> <span class="n">get_monometallic_cluster_labels</span><span class="p">,</span> <span class="n">get_monometallic_slab_labels</span>
<span class="kn">from</span> <span class="nn">.labels</span> <span class="kn">import</span> <span class="n">get_bimetallic_cluster_labels</span><span class="p">,</span> <span class="n">get_bimetallic_slab_labels</span>
<span class="kn">from</span> <span class="nn">.labels</span> <span class="kn">import</span> <span class="n">get_multimetallic_cluster_labels</span><span class="p">,</span> <span class="n">get_multimetallic_slab_labels</span>
<span class="kn">from</span> <span class="nn">ase.data</span> <span class="kn">import</span> <span class="n">reference_states</span><span class="p">,</span> <span class="n">atomic_numbers</span><span class="p">,</span> <span class="n">chemical_symbols</span>
<span class="kn">from</span> <span class="nn">ase.geometry</span> <span class="kn">import</span> <span class="n">find_mic</span>
<span class="kn">from</span> <span class="nn">ase.optimize</span> <span class="kn">import</span> <span class="n">BFGS</span><span class="p">,</span> <span class="n">FIRE</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">asap3.analysis</span> <span class="kn">import</span> <span class="n">rdf</span><span class="p">,</span> <span class="n">FullCNA</span> 
<span class="kn">from</span> <span class="nn">asap3</span> <span class="kn">import</span> <span class="n">FullNeighborList</span>
<span class="kn">from</span> <span class="nn">asap3</span> <span class="kn">import</span> <span class="n">EMT</span> <span class="k">as</span> <span class="n">asapEMT</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">groupby</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>


<div class="viewcode-block" id="ClusterAdsorptionSites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites">[docs]</a><span class="k">class</span> <span class="nc">ClusterAdsorptionSites</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for identifying adsorption sites on a nanoparticle.</span>
<span class="sd">    Support common nanoparticle shapes including: Mackay icosahedron, </span>
<span class="sd">    (truncated) octahedron and (Marks) decahedron.</span>

<span class="sd">    The information of each site is stored in a dictionary with the </span>
<span class="sd">    following keys:</span>

<span class="sd">    **&#39;site&#39;**: the site type, support &#39;ontop&#39;, &#39;bridge&#39;, &#39;longbridge&#39;, </span>
<span class="sd">    &#39;shortbridge&#39;, &#39;fcc&#39;, &#39;hcp&#39;, &#39;3fold&#39;, &#39;4fold&#39;, &#39;5fold&#39;, &#39;6fold&#39;.</span>

<span class="sd">    **&#39;surface&#39;**: the surface of the site, support &#39;vertex&#39;, &#39;edge&#39;,</span>
<span class="sd">    &#39;fcc100&#39;, &#39;fcc111&#39;.</span>

<span class="sd">    **&#39;position&#39;**: the 3D Cartesian coordinate of the site saved as a</span>
<span class="sd">    numpy array.</span>

<span class="sd">    **&#39;normal&#39;**: the surface normal vector of the site saved as a numpy</span>
<span class="sd">    array.</span>

<span class="sd">    **&#39;indices&#39;**: the indices of the atoms that constitute the site.</span>

<span class="sd">    **&#39;composition&#39;**: the elemental composition of the site. Always in </span>
<span class="sd">    the order of atomic numbers.</span>

<span class="sd">    **&#39;subsurf_index&#39;**: the index of the subsurface atom underneath an</span>
<span class="sd">    hcp or 4fold site.</span>

<span class="sd">    **&#39;subsurf_element&#39;**: the element of the subsurface atom underneath</span>
<span class="sd">    an hcp or 4fold site</span>

<span class="sd">    **&#39;label&#39;**: the numerical label assigned to the site if label_sites</span>
<span class="sd">    is set to True. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The atoms object must be a non-periodic nanoparticle.</span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        underneath fcc hollow sites.</span>

<span class="sd">    composition_effect : bool, default False</span>
<span class="sd">        Whether to consider sites with different elemental </span>
<span class="sd">        compositions as different sites. It is recommended to </span>
<span class="sd">        set composition_effect=False for monometallics.</span>

<span class="sd">    label_sites : bool, default False</span>
<span class="sd">        Whether to assign a numerical label to each site.</span>
<span class="sd">        Labels for different sites are listed in acat.labels.</span>
<span class="sd">        Use the bimetallic labels if composition_effect=True,</span>
<span class="sd">        otherwise use the monometallic labels.</span>

<span class="sd">    proxy_metal : str, default None</span>
<span class="sd">        The code is parameterized for pure transition metals.</span>
<span class="sd">        The generalization of the code is achieved by mapping all </span>
<span class="sd">        input atoms to a proxy transition metal that is supported </span>
<span class="sd">        by the asap3.EMT calculator (Ni, Cu, Pd, Ag, Pt or Au).</span>
<span class="sd">        Try changing the proxy metal when the site identification</span>
<span class="sd">        is not satisfying.</span>

<span class="sd">    tol : float, default 0.5</span>
<span class="sd">        The tolerence of neighbor distance (in Angstrom).</span>
<span class="sd">        Might be helpful to adjust this if the site identification </span>
<span class="sd">        is not satisfying. When the nanoparticle is small (less</span>
<span class="sd">        than 300 atoms), Cu is normally the better choice, while </span>
<span class="sd">        Au should be good for larger nanoparticles.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    The following example illustrates the most important use of a</span>
<span class="sd">    `ClusterAdsorptionSites` object - getting all adsorption sites:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import ClusterAdsorptionSites</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Octahedron</span>
<span class="sd">        &gt;&gt;&gt; atoms = Octahedron(&#39;Ni&#39;, length=7, cutoff=2)</span>
<span class="sd">        &gt;&gt;&gt; for atom in atoms:</span>
<span class="sd">        ...     if atom.index % 2 == 0:</span>
<span class="sd">        ...         atom.symbol = &#39;Pt&#39; </span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; cas = ClusterAdsorptionSites(atoms, allow_6fold=False,</span>
<span class="sd">        ...                              composition_effect=True,</span>
<span class="sd">        ...                              label_sites=True)</span>
<span class="sd">        &gt;&gt;&gt; sites = cas.get_sites()</span>
<span class="sd">        &gt;&gt;&gt; print(sites[0])</span>

<span class="sd">    Output:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {&#39;site&#39;: &#39;bridge&#39;, &#39;surface&#39;: &#39;fcc111&#39;, </span>
<span class="sd">         &#39;position&#39;: array([6.96,  7.94, 11.86]), </span>
<span class="sd">         &#39;normal&#39;: array([-0.66666667, -0.66666667, -0.33333333]), </span>
<span class="sd">         &#39;indices&#39;: (0, 2), &#39;composition&#39;: &#39;PtPt&#39;, </span>
<span class="sd">         &#39;subsurf_index&#39;: None, &#39;subsurf_element&#39;: None, &#39;label&#39;: 14}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> 
                 <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">composition_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">label_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">proxy_metal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mf">.5</span><span class="p">):</span>

        <span class="k">assert</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="s1">&#39;the cell must be non-periodic&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">])</span> <span class="o">+</span> <span class="mf">10.</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="o">.</span><span class="n">constraints</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reference_states</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number</span><span class="p">]]]</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="n">allow_6fold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="n">composition_effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_metal</span> <span class="o">=</span> <span class="n">proxy_metal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">)),</span> 
                             <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_sites</span> <span class="o">=</span> <span class="n">label_sites</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> <span class="o">*=</span> <span class="mi">2</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_bimetallic_cluster_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_multimetallic_cluster_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_monometallic_cluster_labels</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fullCNA</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_fullCNA</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_first_neighbor_distance_from_rdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_site_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_neighbor_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_sites</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_site_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_sites</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">()</span>
 
<div class="viewcode-block" id="ClusterAdsorptionSites.populate_site_list"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.populate_site_list">[docs]</a>    <span class="k">def</span> <span class="nf">populate_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all ontop, bridge and hollow sites (3-fold and 4-fold) </span>
<span class="sd">        given an input nanoparticle based on CNA analysis of the suface</span>
<span class="sd">        atoms and collect in a site list.&quot;&quot;&quot;</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_sites</span>
        <span class="n">ssall</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">])</span>
        <span class="n">fcna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fullCNA</span><span class="p">()</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">usi</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># used_site_indices</span>
        <span class="n">normals_for_site</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ssall</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssall</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">surface</span><span class="p">,</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                <span class="n">neighbors</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dist2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblist</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">]))</span>  <span class="c1"># site_indices</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ssall</span> <span class="ow">and</span> <span class="n">si</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usi</span><span class="p">:</span>
                        <span class="c1"># bridge sites</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[[</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">site_surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_designation</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
                        <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;bridge&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="n">site_surf</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>                         
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                            <span class="n">comp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                        <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                        <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                <span class="c1"># Find normal</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ssall</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ssall</span> <span class="ow">and</span> <span class="n">si</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usi</span><span class="p">:</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_angle</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eq</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">3.</span><span class="p">):</span>
                            <span class="c1"># 3-fold (fcc or hcp) site</span>
                            <span class="n">normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_normal</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]:</span>
                                <span class="n">normals_for_site</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">normal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>

                            <span class="n">isubs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span> <span class="k">if</span> 
                                     <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">new_pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isubs</span><span class="p">:</span>
                                <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">isub</span> <span class="o">=</span> <span class="n">isubs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                            <span class="n">site_surf</span> <span class="o">=</span> <span class="s1">&#39;fcc111&#39;</span>

                            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                         <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="n">site_surf</span><span class="p">,</span>
                                         <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                         <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                         <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>                       
                                <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                                    <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span>
                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">)])</span>
                                    <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>   

                            <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">:</span>
                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="n">isub</span><span class="p">})</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> 
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">]})</span>
                            <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                            <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eq</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">):</span>
                            <span class="c1"># 4-fold hollow site</span>
                            <span class="n">site_surf</span> <span class="o">=</span> <span class="s1">&#39;fcc100&#39;</span>
                            <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span>
                            <span class="n">nebs2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblist</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>
                            <span class="n">nebs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nebs2</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nebs2</span><span class="p">:</span>
                                <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span>
                                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ssall</span> <span class="ow">and</span> <span class="n">si</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usi</span><span class="p">:</span>
                                    <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eq</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
                                        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eq</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
                                            <span class="c1"># 4-fold hollow site found</span>
                                            <span class="n">normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_normal</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
                                            <span class="c1"># Save the normals now and add them to the site later</span>
                                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">]:</span>
                                                <span class="n">normals_for_site</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
                                            <span class="n">ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">]]</span>
                                            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
 
                                            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;4fold&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="n">site_surf</span><span class="p">,</span>
                                                         <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                                         <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                                         <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                                <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> 
                                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                    <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                                                    <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                                                    <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mb</span>
                                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                        <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                                        <span class="n">opp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                                              <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                                                              <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> 
                                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                                            <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                                        <span class="k">else</span><span class="p">:</span>
                                                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                                                    <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">ma</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">opp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                                                              <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                                                    <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                                                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                                                    <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>    

                                            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">normal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
                                            <span class="n">isub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>                                            
                                                   <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_pos</span><span class="p">))</span>  
                                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="n">isub</span><span class="p">})</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> 
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">]})</span>
                                            <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                                            <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

                <span class="c1"># ontop sites</span>
                <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;ontop&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="n">surface</span><span class="p">,</span>
                             <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                             <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">s</span><span class="p">,)})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">s</span><span class="p">]})</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">))</span>

        <span class="c1"># Add 6-fold sites if allowed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
            <span class="n">dh</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="mf">5.</span>
            <span class="n">subsurf_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subsurface</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
            <span class="c1"># Add normals to ontop sites</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">normals_for_site</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="c1"># Add normals to bridge sites</span>
            <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span><span class="p">:</span>
                <span class="n">normals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                    <span class="n">normals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normals_for_site</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="c1"># Add subsurf sites</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">:</span>  
                    <span class="n">site</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">subpos</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dh</span>                                   
                    <span class="k">def</span> <span class="nf">get_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">subpos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">subsi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">subsurf_ids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>     
                    <span class="n">si</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;6fold&#39;</span><span class="p">,</span>      
                                 <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">subpos</span><span class="p">,</span>
                                 <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">si</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">subsi</span><span class="p">)))})</span>      
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                        <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
                            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">subsyms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">subi</span><span class="p">]</span> <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">subsi</span><span class="p">]</span>
                            <span class="n">nma</span> <span class="o">=</span> <span class="n">subsyms</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">ia</span> <span class="o">=</span> <span class="n">subsi</span><span class="p">[</span><span class="n">subsyms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ma</span><span class="p">)]</span>
                                <span class="n">subpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)]</span> <span class="o">==</span> <span class="n">ma</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">ib</span> <span class="o">=</span> <span class="n">subsi</span><span class="p">[</span><span class="n">subsyms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mb</span><span class="p">)]</span>
                                <span class="n">subpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)]</span> <span class="o">==</span> <span class="n">mb</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="n">mb</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">endsym</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Z][^A-Z]*&#39;</span><span class="p">,</span> <span class="n">comp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">subpos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span> <span class="k">if</span> 
                                      <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">endsym</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">subsi</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)])</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                    <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                    <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> </div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_site"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_site">[docs]</a>    <span class="k">def</span> <span class="nf">get_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information of a site given its atom indices.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : list or tuple</span>
<span class="sd">            The indices of the atoms that contribute to the site.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        <span class="n">st</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="k">if</span> 
                   <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">indices</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">st</span> </div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">composition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">subsurf_element</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information of all sites.</span>
<span class="sd">                                                                     </span>
<span class="sd">        Parameters                                                   </span>
<span class="sd">        ----------                                                   </span>
<span class="sd">        site : str, default None</span>
<span class="sd">            Only return sites that belongs to this site type.</span>

<span class="sd">        surface : str, default None</span>
<span class="sd">            Only return sites that are on this surface.</span>

<span class="sd">        composition : str, default None</span>
<span class="sd">            Only return sites that have this composition.</span>

<span class="sd">        subsurf_element : str, default None</span>
<span class="sd">            Only return sites that have this subsurface element.</span>
<span class="sd">                                                                     </span>
<span class="sd">        &quot;&quot;&quot;</span>                                                          

        <span class="n">all_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">surface</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">composition</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">composition</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">scomp</span> <span class="o">=</span> <span class="n">composition</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Z][^A-Z]*&#39;</span><span class="p">,</span> <span class="n">composition</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                           <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                               <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">scomp</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">scomp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subsurf_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">]</span> 
                         <span class="o">==</span> <span class="n">subsurf_element</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">all_sites</span></div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_unique_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_unique_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_unique_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_composition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>         
                         <span class="n">unique_subsurf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all symmetry-inequivalent adsorption sites.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unique_composition : bool, default False</span>
<span class="sd">            Take site composition into consideration when </span>
<span class="sd">            checking uniqueness.</span>

<span class="sd">        unique_subsurf : bool, default False</span>
<span class="sd">            Take subsurface element into consideration when </span>
<span class="sd">            checking uniqueness. Could be important for </span>
<span class="sd">            surfaces like fcc100.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;surface&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unique_composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the site list does not include &#39;</span>
                                 <span class="o">+</span> <span class="s1">&#39;information of composition&#39;</span><span class="p">)</span>
            <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;composition&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_subsurf</span><span class="p">:</span>
                <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unique_subsurf</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;to include the subsurface element, &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;unique_composition also need to be set to True&#39;</span><span class="p">)</span>    
        <span class="n">sklist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">])</span>
 
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sklist</span> <span class="k">for</span> <span class="n">sklist</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">sklist</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Assign labels</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]]</span>
            <span class="n">stlab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stlab</span>                                                   

    <span class="k">def</span> <span class="nf">new_site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.mapping"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.mapping">[docs]</a>    <span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map the nanoparticle into a proxy nanoparticle for code</span>
<span class="sd">        versatility.&quot;&quot;&quot;</span>

        <span class="n">ref_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_metal</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_symbol</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Au&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="s1">&#39;Cu&#39;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ref_atoms</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">ref_symbol</span>

        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">asapEMT</span><span class="p">()</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">FIRE</span><span class="p">(</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span>              

        <span class="k">return</span> <span class="n">ref_atoms</span></div>

    <span class="k">def</span> <span class="nf">get_two_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">vec1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">vec2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span>

    <span class="k">def</span> <span class="nf">is_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_surface_normal"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_surface_normal">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Get the surface normal vector of the plane from the indices </span>
<span class="sd">        of 3 atoms that forms to that plane.                                    </span>
<span class="sd">                                                                    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : list of tuple</span>
<span class="sd">            The indices of the atoms that forms the plane.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_two_vectors</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">@</span> <span class="n">n</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">l</span>
        <span class="c1"># Add support for having adsorbates on the particles already</span>
        <span class="c1"># by putting in elements to check for in the function below</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_atom_too_close_to_pos</span><span class="p">(</span><span class="n">new_pos</span><span class="p">,</span> <span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">j</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">l</span></div>

    <span class="k">def</span> <span class="nf">get_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_two_vectors</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec1</span> <span class="o">@</span> <span class="n">vec2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.no_atom_too_close_to_pos"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.no_atom_too_close_to_pos">[docs]</a>    <span class="k">def</span> <span class="nf">no_atom_too_close_to_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">mindist</span><span class="p">):</span>              
        <span class="sd">&quot;&quot;&quot;Returns True if no atoms are closer than mindist to pos,</span>
<span class="sd">        otherwise False.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : numpy.array</span>
<span class="sd">            The position to be checked.</span>

<span class="sd">        mindist : float</span>
<span class="sd">            The minimum distance (in Angstrom) that is not considered </span>
<span class="sd">            as too close.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mindist</span>
                 <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>                                                       </div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_surface_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_surface_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Returns the indices of the surface atoms and a dictionary </span>
<span class="sd">        with all the surface designations.&quot;&quot;&quot;</span>

        <span class="n">surf_sites</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;fcc111&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;fcc100&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">[],</span>
                      <span class="s1">&#39;vertex&#39;</span><span class="p">:</span> <span class="p">[],}</span>
        <span class="n">fcna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fullCNA</span><span class="p">()</span>
        <span class="n">site_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_dict</span>
        <span class="n">surf_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
<span class="c1">#            if i in [284, 310]:</span>
<span class="c1">#                print(fcna[i])</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">surf_sites</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site_dict</span><span class="p">:</span>
                    <span class="c1"># The structure is distorted from the original, giving</span>
                    <span class="c1"># a larger cutoff should overcome this problem</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
                    <span class="n">fcna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fullCNA</span><span class="p">(</span><span class="n">rCut</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site_dict</span><span class="p">:</span>
                    <span class="c1"># If this does not solve the problem we probably have a</span>
                    <span class="c1"># reconstruction of the surface and will leave this</span>
                    <span class="c1"># atom unused this time</span>
                    <span class="k">continue</span>
                <span class="n">surf_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">surf_sites</span><span class="p">[</span><span class="n">site_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">i</span><span class="p">])]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">surf_ids</span><span class="p">,</span> <span class="n">surf_sites</span>  </div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_subsurface"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_subsurface">[docs]</a>    <span class="k">def</span> <span class="nf">get_subsurface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the indices of the subsurface atoms.&quot;&quot;&quot;</span>

        <span class="n">notsurf</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">]</span>
        <span class="n">subfcna</span> <span class="o">=</span> <span class="n">FullCNA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">[</span><span class="n">notsurf</span><span class="p">])</span><span class="o">.</span><span class="n">get_normal_cna</span><span class="p">()</span> 
        
        <span class="k">return</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">notsurf</span><span class="p">)</span> <span class="k">if</span> 
                <span class="nb">sum</span><span class="p">(</span><span class="n">subfcna</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">make_fullCNA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rCut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                  
        <span class="k">if</span> <span class="n">rCut</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullCNA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullCNA</span><span class="p">[</span><span class="n">rCut</span><span class="p">]</span> <span class="o">=</span> <span class="n">FullCNA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="n">rCut</span><span class="o">=</span><span class="n">rCut</span><span class="p">)</span><span class="o">.</span><span class="n">get_normal_cna</span><span class="p">()</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_fullCNA"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_fullCNA">[docs]</a>    <span class="k">def</span> <span class="nf">get_fullCNA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rCut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the CNA signatures of all atoms by asap3 full CNA </span>
<span class="sd">        analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rCut : float, default None</span>
<span class="sd">            The cutoff radius in Angstrom. If not specified, the </span>
<span class="sd">            asap3 CNA analysis will use a reasonable cutoff based </span>
<span class="sd">            on the crystalline lattice constant of the material.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rCut</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullCNA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_fullCNA</span><span class="p">(</span><span class="n">rCut</span><span class="o">=</span><span class="n">rCut</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullCNA</span><span class="p">[</span><span class="n">rCut</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">make_neighbor_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rMax</span><span class="o">=</span><span class="mf">10.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an asap3 neighborlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rMax : float, default 10.</span>
<span class="sd">            The maximum cutoff radius in Angstrom. </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nblist</span> <span class="o">=</span> <span class="n">FullNeighborList</span><span class="p">(</span><span class="n">rCut</span><span class="o">=</span><span class="n">rMax</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_connectivity"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">get_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                      
        <span class="sd">&quot;&quot;&quot;Get the connection matrix.&quot;&quot;&quot;</span>

        <span class="n">nbslist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_connectivity_matrix</span><span class="p">(</span><span class="n">nbslist</span><span class="p">)</span>                  </div>

    <span class="k">def</span> <span class="nf">get_site_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">icosa_dict</span> <span class="o">=</span> <span class="p">{</span>                                                                                     
            <span class="c1"># Triangle sites on outermost shell -- Icosa, Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">}):</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc111&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">})],</span>
            <span class="c1"># Edge sites on outermost shell -- Icosa</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">})],</span>
            <span class="c1"># Vertice sites on outermost shell -- Icosa, Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vertex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
        <span class="p">}</span>
        
        <span class="n">cubocta_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Edge sites on outermost shell -- Cubocta, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">})],</span>
            <span class="c1"># Square sites on outermost shell -- Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">}):</span> <span class="s1">&#39;fcc100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc100&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">})],</span>
            <span class="c1"># Vertice sites on outermost shell -- Cubocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vertex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
            <span class="c1"># Triangle sites on outermost shell -- Icosa, Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">}):</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc111&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">})],</span>
        <span class="p">}</span>
        
        <span class="n">mdeca_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Edge sites (111)-(111) on outermost shell -- Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">}),</span> 
                     <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">}),</span> 
                     <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
            <span class="c1"># Edge sites (111)-(100) on outermost shell -- Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="c1"># Edge sites (111)-(111)notch on outermost shell -- Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="c1"># Square sites on outermost shell -- Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">}):</span> <span class="s1">&#39;fcc100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc100&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">})],</span>
            <span class="c1"># Vertice sites on outermost shell -- Icosa, Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vertex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mi">1</span><span class="p">}),</span> 
                       <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}),</span> 
                       <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> 
                            <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
            <span class="c1"># Vertice sites A on outermost shell -- Mdeca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="c1"># Vertice sites B on outermost shell -- Mdeca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> 
                 <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="c1"># Triangle (pentagon) sites on outermost shell -- Icosa, Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">}):</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc111&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">}),</span> 
                       <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">})],</span>
            <span class="c1"># Triangle (pentagon) notch sites on outermost shell -- Deca</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="n">tocta_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Edge sites on outermost shell -- Cubocta, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">}),</span> 
                     <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
            <span class="c1"># Edge sites (111)-(111) on outermost shell -- Octa</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
            <span class="c1"># Square sites on outermost shell -- Cubocta, Deca, Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">}):</span> <span class="s1">&#39;fcc100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc100&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">})],</span>
            <span class="c1"># Vertice sites on outermost shell -- Tocta</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">}):</span> <span class="s1">&#39;vertex&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vertex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">})],</span>
            <span class="c1"># Triangle (pentagon) sites on outermost shell -- Icosa, Cubocta, Deca, Octa</span>
            <span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">}):</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fcc111&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">({(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">})],</span>
        <span class="p">}</span>
        
        <span class="n">fcna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fullCNA</span><span class="p">()</span>
        <span class="n">icosa_weight</span> <span class="o">=</span> <span class="n">cubocta_weight</span> <span class="o">=</span> <span class="n">mdeca_weight</span> <span class="o">=</span> <span class="n">tocta_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fcna</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">icosa_dict</span><span class="p">:</span>
                <span class="n">icosa_weight</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cubocta_dict</span><span class="p">:</span>
                <span class="n">cubocta_weight</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mdeca_dict</span><span class="p">:</span>
                <span class="n">mdeca_weight</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tocta_dict</span><span class="p">:</span>
                <span class="n">tocta_weight</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">full_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">icosa_weight</span><span class="p">,</span> <span class="n">cubocta_weight</span><span class="p">,</span> 
                        <span class="n">mdeca_weight</span><span class="p">,</span> <span class="n">tocta_weight</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">icosa_weight</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">full_weights</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">icosa_dict</span>
        <span class="k">elif</span> <span class="n">cubocta_weight</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">full_weights</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cubocta_dict</span>
        <span class="k">elif</span> <span class="n">tocta_weight</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">full_weights</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tocta_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mdeca_dict</span>

    <span class="k">def</span> <span class="nf">set_first_neighbor_distance_from_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rMax</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nBins</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())):</span>
            <span class="k">if</span> <span class="n">L</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span> 
        <span class="n">_rdf</span> <span class="o">=</span> <span class="n">rdf</span><span class="o">.</span><span class="n">RadialDistributionFunction</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">rMax</span><span class="p">,</span> <span class="n">nBins</span><span class="p">)</span><span class="o">.</span><span class="n">get_rdf</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nBins</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">rMax</span> <span class="o">/</span> <span class="n">nBins</span>
        <span class="n">_rdf</span> <span class="o">*=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">diff_rdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">_rdf</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">diff_rdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_surface_designation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>                                 
        <span class="n">fcna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fullCNA</span><span class="p">()</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_dict</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">sd</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">s</span><span class="p">])]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sd</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
               <span class="c1"># for s in [indices[0], indices[1]]:</span>
               <span class="c1">#     scna = str(fcna[s])</span>
               <span class="c1">#     if scna not in sd:</span>
               <span class="c1">#         print(&#39;CNA {} is not supported.&#39;.format(scna))</span>
                <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]])]</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fcna</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span>
            <span class="n">ss01</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">ss01</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">),</span> 
                        <span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;vertex&#39;</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="s1">&#39;edge&#39;</span>
            <span class="k">elif</span> <span class="n">ss01</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">),</span> 
                          <span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">),</span> 
                          <span class="p">(</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc111&#39;</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="s1">&#39;fcc111&#39;</span>
            <span class="k">elif</span> <span class="n">ss01</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">),</span> 
                          <span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc100&#39;</span><span class="p">),</span> 
                          <span class="p">(</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span> <span class="s1">&#39;fcc100&#39;</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="s1">&#39;fcc100&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;fcc111&#39;</span>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_graph"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                             
        <span class="sd">&quot;&quot;&quot;Get the graph representation of the nanoparticle.&quot;&quot;&quot;</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connectivity</span><span class="p">()</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>                               
        <span class="c1"># Add edges from surface connectivity matrix</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">cols</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span></div>

<div class="viewcode-block" id="ClusterAdsorptionSites.get_neighbor_site_list"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.get_neighbor_site_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighbor_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>           
        <span class="sd">&quot;&quot;&quot;Returns the site_list index of all neighbor shell sites </span>
<span class="sd">        for each site.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        neighbor_number : int, default 1</span>
<span class="sd">            Neighbor shell number. </span>

<span class="sd">        span : bool, default True</span>
<span class="sd">            Whether to include all neighbors sites spanned within </span>
<span class="sd">            the shell.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">adsposs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*</span> \
                             <span class="n">site_heights</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">])</span>
        <span class="n">statoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="s1">&#39;X</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)),</span> 
                        <span class="n">positions</span><span class="o">=</span><span class="n">adsposs</span><span class="p">,</span> 
                        <span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                        <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="mf">0.55</span> 
        <span class="k">if</span> <span class="n">neighbor_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cr</span> <span class="o">+=</span> <span class="mf">0.1</span>
                                                                   
        <span class="n">nbslist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="n">statoms</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="p">,</span>
                                      <span class="n">mic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">cr</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neighbor_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">topi_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span><span class="p">:</span>
                    <span class="n">topi_dict</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc&#39;</span><span class="p">,</span><span class="s1">&#39;hcp&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">topi_dict</span><span class="p">:</span>
                            <span class="n">nbslist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topi_dict</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> 
        <span class="k">return</span> <span class="n">nbslist</span></div>

<div class="viewcode-block" id="ClusterAdsorptionSites.update"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.ClusterAdsorptionSites.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">update_composition</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>                 
        <span class="sd">&quot;&quot;&quot;Update the position and composition of each adsorption site </span>
<span class="sd">        given an updated atoms object. Please only use this when the </span>
<span class="sd">        indexing of the atoms object is preserved. Useful for updating</span>
<span class="sd">        adsorption sites e.g. after geometry optimization.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atoms : ase.Atoms object</span>
<span class="sd">            The updated atoms object. </span>

<span class="sd">        update_composition : bool, default False</span>
<span class="sd">            Whether to update the composition as well. It is recommended</span>
<span class="sd">            to only set update_composition=True if the composition of </span>
<span class="sd">            the surface is not fixed.  </span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
            <span class="n">newpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newpos</span>
            <span class="k">if</span> <span class="n">update_composition</span><span class="p">:</span>
                <span class="n">newcomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span>
                                         <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                <span class="n">st</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcomp</span>                           </div></div>


<div class="viewcode-block" id="group_sites_by_facet"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.group_sites_by_facet">[docs]</a><span class="k">def</span> <span class="nf">group_sites_by_facet</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">all_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>            
    <span class="sd">&quot;&quot;&quot;A function that uses networkx to group one set of sites by</span>
<span class="sd">    geometrical facets of the nanoparticle. Different geometrical</span>
<span class="sd">    facets can have the same surface type. The function returns a</span>
<span class="sd">    list of lists, each contains sites on a same geometrical facet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The atoms object must be a non-periodic nanoparticle.</span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    sites : list of dicts</span>
<span class="sd">        The adsorption sites to be grouped by geometrical facet.</span>

<span class="sd">    all_sites : list of dicts, default None</span>
<span class="sd">        The list of all sites. Provide this to make the grouping</span>
<span class="sd">        much faster. Useful when the function is called many times.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    The following example shows how to group all fcc sites of an </span>
<span class="sd">    icosahedral nanoparticle by its 20 geometrical facets:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import ClusterAdsorptionSites</span>
<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import group_sites_by_facet</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Icosahedron</span>
<span class="sd">        &gt;&gt;&gt; atoms = Icosahedron(&#39;Pt&#39;, noshells=5)</span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; cas = ClusterAdsorptionSites(atoms)</span>
<span class="sd">        &gt;&gt;&gt; all_sites = cas.get_sites()</span>
<span class="sd">        &gt;&gt;&gt; fcc_sites = [s for s in all_sites if s[&#39;site&#39;] == &#39;fcc&#39;]</span>
<span class="sd">        &gt;&gt;&gt; groups = group_sites_by_facet(atoms, fcc_sites, all_sites)         </span>
<span class="sd">        &gt;&gt;&gt; print(len(groups))</span>

<span class="sd">    Output:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        20</span>

<span class="sd">    &quot;&quot;&quot;</span>
                                                                     
    <span class="c1"># Find all indices of vertex and edge sites</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_sites</span><span class="p">:</span>
        <span class="n">cas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">all_sites</span> <span class="o">=</span> <span class="n">cas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="n">ve_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> 
                  <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span> <span class="ow">and</span> 
                  <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;vertex&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">]]</span>
    <span class="n">unique_ve_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ve_indices</span><span class="p">,</span> <span class="p">())))</span>
     
    <span class="n">G</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
        <span class="n">reduced_indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">if</span> <span class="n">i</span> 
                                <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_ve_indices</span><span class="p">)</span>
        <span class="n">site</span><span class="p">[</span><span class="s1">&#39;reduced_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduced_indices</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">reduced_indices</span><span class="p">)</span>
    <span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;reduced_indices&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="n">grouped_sites</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;reduced_indices&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">grouped_sites</span><span class="p">[</span><span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">site</span><span class="p">]</span>
                                                                     
    <span class="k">return</span> <span class="n">grouped_sites</span></div>


<div class="viewcode-block" id="SlabAdsorptionSites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites">[docs]</a><span class="k">class</span> <span class="nc">SlabAdsorptionSites</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for identifying adsorption sites on a surface slab.</span>
<span class="sd">    Support 20 common surfaces: fcc100, fcc111, fcc110, fcc211,</span>
<span class="sd">    fcc221, fcc311, fcc322, fcc331, fcc332, bcc100, bcc111, bcc110,</span>
<span class="sd">    bcc210, bcc211, bcc310, hcp0001, hcp10m10t, hcp10m10h, </span>
<span class="sd">    hcp10m11, hcp10m12.</span>

<span class="sd">    The information of each site is stored in a dictionary with the </span>
<span class="sd">    following keys:</span>

<span class="sd">    **&#39;site&#39;**: the site type, support &#39;ontop&#39;, &#39;bridge&#39;, &#39;longbridge&#39;, </span>
<span class="sd">    &#39;shortbridge&#39;, &#39;fcc&#39;, &#39;hcp&#39;, &#39;3fold&#39;, &#39;4fold&#39;, &#39;5fold&#39;, &#39;6fold&#39;.</span>

<span class="sd">    **&#39;surface&#39;**: the surface type (crystal structure + Miller indices) </span>
<span class="sd">    of the slab. Support 20 surfaces as listed above.</span>

<span class="sd">    **&#39;morphology&#39;**: the local surface morphology of the site. Support</span>
<span class="sd">    &#39;step&#39;, &#39;terrace&#39;, &#39;corner&#39;, &#39;sc-tc-x&#39;, &#39;tc-cc-x&#39;, &#39;sc-cc-x&#39;.</span>
<span class="sd">    &#39;sc&#39;, &#39;tc&#39; and &#39;cc&#39; represents step chain, terrace chain and corner, </span>
<span class="sd">    respectively. &#39;x&#39; is the Bravais lattice that connects the 2 chains,</span>
<span class="sd">    e.g. &#39;h&#39; = hexagonal, &#39;t&#39; = &#39;tetragonal&#39;, &#39;o&#39; = &#39;orthorhombic&#39;.</span>

<span class="sd">    **&#39;position&#39;**: the 3D Cartesian coordinate of the site saved as a</span>
<span class="sd">    numpy array.</span>

<span class="sd">    **&#39;normal&#39;**: the surface normal vector of the site saved as a numpy</span>
<span class="sd">    array.</span>

<span class="sd">    **&#39;indices&#39;**: the indices of the atoms that constitute the site.</span>

<span class="sd">    **&#39;composition&#39;**: the elemental composition of the site. Always in </span>
<span class="sd">    the order of atomic numbers.</span>

<span class="sd">    **&#39;subsurf_index&#39;**: the index of the subsurface atom underneath an</span>
<span class="sd">    hcp or 4fold site.</span>

<span class="sd">    **&#39;subsurf_element&#39;**: the element of the subsurface atom underneath</span>
<span class="sd">    an hcp or 4fold site</span>

<span class="sd">    **&#39;label&#39;**: the numerical label assigned to the site if label_sites</span>
<span class="sd">    is set to True.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        The atoms object must be a periodic surface slab with at </span>
<span class="sd">        least 3 layers (e.g. all surface atoms make up one layer). </span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    surface : str</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        underneath fcc hollow sites.</span>

<span class="sd">    composition_effect : bool, default False</span>
<span class="sd">        Whether to consider sites with different elemental </span>
<span class="sd">        compositions as different sites. It is recommended to </span>
<span class="sd">        set composition_effect=False for monometallics.        </span>

<span class="sd">    both_sides : bool, default False</span>
<span class="sd">        Whether to consider sites on both top and bottom sides</span>
<span class="sd">        of the slab.</span>

<span class="sd">    label_sites : bool, default False</span>
<span class="sd">        Whether to assign a numerical label to each site.</span>
<span class="sd">        Labels for different sites are listed in acat.labels.</span>
<span class="sd">        Use the bimetallic labels if composition_effect=True,</span>
<span class="sd">        otherwise use the monometallic labels.</span>

<span class="sd">    proxy_metal : str, default None</span>
<span class="sd">        The code is parameterized for pure transition metals.</span>
<span class="sd">        The generalization of the code is achieved by mapping all </span>
<span class="sd">        input atoms to a proxy transition metal that is supported </span>
<span class="sd">        by the asap3.EMT calculator (Ni, Cu, Pd, Ag, Pt or Au).</span>
<span class="sd">        Try changing the proxy metal when the site identification</span>
<span class="sd">        is not satisfying. When the cell is small, Cu is normally </span>
<span class="sd">        the better choice, while the Pt and Au should be good for </span>
<span class="sd">        larger cells.</span>

<span class="sd">    tol : float, default 0.5</span>
<span class="sd">        The tolerence of neighbor distance (in Angstrom).</span>
<span class="sd">        Might be helpful to adjust this if the site identification </span>
<span class="sd">        is not satisfying. The default 0.5 is usually good enough.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    The following example illustrates the most important use of a</span>
<span class="sd">    `SlabAdsorptionSites` object - getting all adsorption sites:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import SlabAdsorptionSites</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import fcc211</span>
<span class="sd">        &gt;&gt;&gt; atoms = fcc211(&#39;Cu&#39;, (3, 3, 4), vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; for atom in atoms:</span>
<span class="sd">        ...     if atom.index % 2 == 0:</span>
<span class="sd">        ...         atom.symbol = &#39;Au&#39; </span>
<span class="sd">        &gt;&gt;&gt; atoms.center()</span>
<span class="sd">        &gt;&gt;&gt; sas = SlabAdsorptionSites(atoms, surface=&#39;fcc211&#39;,</span>
<span class="sd">        ...                           allow_6fold=False,</span>
<span class="sd">        ...                           composition_effect=True,</span>
<span class="sd">        ...                           label_sites=True)</span>
<span class="sd">        &gt;&gt;&gt; sites = sas.get_sites()</span>
<span class="sd">        &gt;&gt;&gt; print(sites[-1])</span>

<span class="sd">    Output:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {&#39;site&#39;: &#39;hcp&#39;, &#39;surface&#39;: &#39;fcc211&#39;, &#39;morphology&#39;: &#39;sc-tc-h&#39;, </span>
<span class="sd">         &#39;position&#39;: array([ 4.51584136,  0.63816387, 12.86014042]), </span>
<span class="sd">         &#39;normal&#39;: array([-0.33333333, -0.        ,  0.94280904]), </span>
<span class="sd">         &#39;indices&#39;: (0, 2, 3), &#39;composition&#39;: &#39;CuAuAu&#39;, </span>
<span class="sd">         &#39;subsurf_index&#39;: 9, &#39;subsurf_element&#39;: &#39;Cu&#39;, &#39;label&#39;: 28}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> 
                 <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">composition_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">both_sides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">label_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">proxy_metal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mf">.5</span><span class="p">):</span>

        <span class="k">assert</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="s1">&#39;the cell must be periodic in at least one direction&#39;</span>   
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

        <span class="n">ptp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> 
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">ptp</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">:</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptp</span> <span class="o">+</span> <span class="mf">10.</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="o">.</span><span class="n">constraints</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reference_states</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">number</span><span class="p">]]]</span>
        <span class="k">del</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_metal</span> <span class="o">=</span> <span class="n">proxy_metal</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">)),</span> 
                             <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span> <span class="o">=</span> <span class="n">allow_6fold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span> <span class="o">=</span> <span class="n">composition_effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">both_sides</span> <span class="o">=</span> <span class="n">both_sides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_sites</span> <span class="o">=</span> <span class="n">label_sites</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_bimetallic_slab_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_multimetallic_slab_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span> <span class="o">=</span> <span class="n">get_monometallic_slab_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">)</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">make_neighbor_list</span><span class="p">(</span><span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connectivity</span><span class="p">()</span>         

        <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_termination</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_site_list</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">both_sides</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_opposite_site_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_sites</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">()</span>
        
<div class="viewcode-block" id="SlabAdsorptionSites.populate_site_list"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.populate_site_list">[docs]</a>    <span class="k">def</span> <span class="nf">populate_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_obtuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">_bot_side</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;Find all ontop, bridge and hollow sites (3-fold and 4-fold) </span>
<span class="sd">        given an input slab based on Delaunay triangulation of the </span>
<span class="sd">        surface atoms in a supercell and collect in a site list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        allow_obtuse : bool, default True</span>
<span class="sd">            Whether simplices with obtuse angles are considered in the</span>
<span class="sd">            Delaunay triangulation.</span>

<span class="sd">        cutoff : float, default 5.</span>
<span class="sd">            Radius of maximum atomic bond distance to consider.</span>

<span class="sd">        &quot;&quot;&quot;</span>
 
        <span class="n">top_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">normals_for_site</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">top_indices</span><span class="p">,</span> 
                            <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">])))</span>
        <span class="n">usi</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># used_site_indices</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_matrix</span> 
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">:</span>
            <span class="n">occurence</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">sumo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">occurence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc110&#39;</span><span class="p">,</span><span class="s1">&#39;hcp0001&#39;</span><span class="p">]:</span>
                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sumo</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sumo</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc332&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                <span class="k">elif</span> <span class="n">sumo</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc210&#39;</span><span class="p">:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                <span class="k">elif</span> <span class="n">sumo</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc332&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hcp10m12&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;bcc111&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hcp10m10t&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                <span class="k">elif</span> <span class="n">sumo</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc332&#39;</span><span class="p">,</span><span class="s1">&#39;bcc111&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m12&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>

            <span class="n">si</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,)</span>
            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span> 
            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;ontop&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                         <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                         <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                         <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">morphology</span> <span class="o">==</span> <span class="s1">&#39;terrace&#39;</span><span class="p">:</span>
                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">occurence</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">s</span><span class="p">]})</span>
            <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
            <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

        <span class="n">stepids</span><span class="p">,</span> <span class="n">terraceids</span><span class="p">,</span> <span class="n">cornerids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">geo</span> <span class="o">=</span> <span class="n">sit</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">sit</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">geo</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
                <span class="n">stepids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">geo</span> <span class="o">==</span> <span class="s1">&#39;terrace&#39;</span><span class="p">:</span>
                <span class="n">terraceids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">geo</span> <span class="o">==</span> <span class="s1">&#39;corner&#39;</span><span class="p">:</span>
                <span class="n">cornerids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">geo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">stepids</span><span class="p">,</span> <span class="s1">&#39;terrace&#39;</span><span class="p">:</span> <span class="n">terraceids</span><span class="p">,</span> <span class="s1">&#39;corner&#39;</span><span class="p">:</span> <span class="n">cornerids</span><span class="p">}</span>

        <span class="c1"># Sort by z coordinates if different geometries have same sumo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc210&#39;</span><span class="p">:</span>
            <span class="n">sorted_steps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stepids</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">stpi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_steps</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_steps</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_bot_side</span><span class="p">:</span>
                        <span class="n">stepids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stpi</span><span class="p">)</span>
                        <span class="n">terraceids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stpi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_bot_side</span><span class="p">:</span>
                        <span class="n">stepids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stpi</span><span class="p">)</span>
                        <span class="n">terraceids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stpi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span> <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">terraceids</span><span class="p">:</span>
                    <span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]:</span>   
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;extra&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
                    <span class="n">extra</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">]</span>
                    <span class="n">extraids</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extra</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span>
                                <span class="ow">and</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geo_dict</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]]</span>
                    <span class="c1">#if len(extraids) &lt; 4:    </span>
                    <span class="c1">#    print(&#39;Cannot identify other 4 atoms of 5-fold site {}&#39;.format(si))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extraids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">extraids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extraids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>                
                                   <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">refpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                   <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">4</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                        <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
                            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                       
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extraids</span><span class="p">]</span>
                            <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">idd</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extraids</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>    
                                      <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">extraids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">opp</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">idd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">extraids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">close</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">extraids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">ma</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">opp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">extraids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                      <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">extraids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                            <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extraids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">extraids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span> 
                    <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">)</span><span class="o">+</span> <span class="n">extraids</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">]</span>

        <span class="n">ext_index</span><span class="p">,</span> <span class="n">ext_coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">expand_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="n">extended_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">ext_index</span><span class="p">,</span> <span class="n">top_indices</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext_surf_coords</span> <span class="o">=</span> <span class="n">ext_coords</span><span class="p">[</span><span class="n">extended_top</span><span class="p">]</span>
        <span class="n">meansurfz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">meansurfz</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1">#        surf_screen = np.where(abs(ext_surf_coords[:,2] - meansurfz) &lt; 5.)</span>
<span class="c1">#        ext_surf_coords = ext_surf_coords[surf_screen]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">ext_surf_coords</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">neighbors</span>
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">simplices</span>

        <span class="n">bridge_positions</span><span class="p">,</span> <span class="n">fold3_positions</span><span class="p">,</span> <span class="n">fold4_positions</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">bridge_points</span><span class="p">,</span> <span class="n">fold3_points</span><span class="p">,</span> <span class="n">fold4_points</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
         
        <span class="c1"># Delaunay triangulation (borrow from Catkit)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">corners</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simplices</span><span class="p">):</span>
            <span class="n">cir</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">circulant</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">cir</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># Inner angle of each triangle corner</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">edges</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">corners</span><span class="p">]</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">uvec</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvec</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Angle types</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">obtuse</span> <span class="o">=</span> <span class="p">(</span><span class="n">angles</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">)</span>
            <span class="n">rh_corner</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
            <span class="n">edge_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">obtuse</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_obtuse</span><span class="p">:</span>
                <span class="c1"># Assumption: All simplices with obtuse angles</span>
                <span class="c1"># are irrelevant boundaries.</span>
                <span class="k">continue</span>
            <span class="n">bridge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">edges</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c1"># Looping through corners allows for elimination of</span>
            <span class="c1"># redundant points, identification of 4-fold hollows,</span>
            <span class="c1"># and collection of bridge neighbors.            </span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corners</span><span class="p">):</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">bridge_points</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get the bridge neighbors (for adsorption vector)</span>
                <span class="n">neighbor_simplex</span> <span class="o">=</span> <span class="n">simplices</span><span class="p">[</span><span class="n">edge_neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                <span class="n">oc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">neighbor_simplex</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">edge</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Right angles potentially indicate 4-fold hollow</span>
                <span class="n">potential_hollow</span> <span class="o">=</span> <span class="n">edge</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">oc</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rh_corner</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">potential_hollow</span> <span class="ow">in</span> <span class="n">fold4_points</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Assumption: If not 4-fold, this suggests</span>
                    <span class="c1"># no hollow OR bridge site is present.</span>
                    <span class="n">ovec</span> <span class="o">=</span> <span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span>
                    <span class="n">ouvec</span> <span class="o">=</span> <span class="n">ovec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ovec</span><span class="p">)</span>
                    <span class="n">oangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">*</span><span class="n">ouvec</span><span class="p">)</span>
                    <span class="n">oright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">oangle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">oright</span><span class="p">:</span>
                        <span class="n">fold4_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potential_hollow</span><span class="p">)</span>
                        <span class="n">fold4_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bridge</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bridge_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                    <span class="n">bridge_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bridge</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">right</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obtuse</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">fold3_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ext_surf_coords</span><span class="p">[</span><span class="n">corners</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fold3_points</span> <span class="o">+=</span> <span class="n">corners</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">fold3_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold3_position</span><span class="p">)</span>

        <span class="n">fold4_surfaces</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;bcc100&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;bcc210&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10t&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m11&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m12&#39;</span><span class="p">]</span>

        <span class="c1"># Complete information of each site</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">poss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">bridge_positions</span><span class="p">,</span><span class="n">fold4_positions</span><span class="p">,</span><span class="n">fold3_positions</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">poss</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">poss</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">xfracs</span><span class="p">,</span> <span class="n">yfracs</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">fracs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Take only the positions within the periodic boundary</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xfracs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xfracs</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">&amp;</span> \
                              <span class="p">(</span><span class="n">yfracs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yfracs</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reduced_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">poss</span><span class="p">)[</span><span class="n">screen</span><span class="p">]</span>
            
            <span class="c1"># Sort the index list of surface and subsurface atoms </span>
            <span class="c1"># so that we can retrive original indices later</span>
            <span class="n">top2_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span>
            <span class="n">top2atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">[</span><span class="n">top2_indices</span><span class="p">]</span>

            <span class="c1"># Make a new neighborlist including sites as dummy atoms</span>
            <span class="n">dummies</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="s1">&#39;X</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reduced_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                            <span class="n">positions</span><span class="o">=</span><span class="n">reduced_poss</span><span class="p">,</span> 
                            <span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                            <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
            <span class="n">ntop1</span><span class="p">,</span> <span class="n">ntop2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">top2atoms</span><span class="p">)</span>
            <span class="n">testatoms</span> <span class="o">=</span> <span class="n">top2atoms</span> <span class="o">+</span> <span class="n">dummies</span>
            <span class="n">nblist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="n">testatoms</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                         <span class="n">different_species</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="c1"># Make bridge sites  </span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fold4_poss</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">refpos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">):</span>
                    <span class="n">bridge_indices</span> <span class="o">=</span> <span class="n">nblist</span><span class="p">[</span><span class="n">ntop2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>                     
                    <span class="n">bridgeids</span> <span class="o">=</span> <span class="p">[</span><span class="n">top2_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bridge_indices</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ntop1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bridgeids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;bcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m11&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m12&#39;</span><span class="p">]:</span>
                            <span class="n">fold4_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refpos</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">bridgeids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bridgeids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                               <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">refpos</span><span class="p">,</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bridgeids</span><span class="p">))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">refpos</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span><span class="p">[</span><span class="n">bridgeids</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> 
                    <span class="n">occurence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">bridgeids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">siset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                    <span class="n">nstep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stepids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                    <span class="n">nterrace</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terraceids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>              
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>                            
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> 
                            <span class="k">continue</span> 
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">cto2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">occurence</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-t&#39;</span>
                            <span class="k">elif</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> 
                            <span class="k">continue</span>          
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">]:</span>             
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="n">ncorner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-t&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                        <span class="c1"># nterrace == 2 is actually terrace bridge, </span>
                        <span class="c1"># but equivalent to tc-cc-h for fcc211</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;fcc211&#39;</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-h&#39;</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;fcc322&#39;</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> 
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc332&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="n">ncorner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc110&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;shortbridge&#39;</span><span class="p">,</span> <span class="s1">&#39;terrace&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc111&#39;</span><span class="p">:</span>
                        <span class="n">ncorner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;longbridge&#39;</span><span class="p">,</span> <span class="s1">&#39;sc-cc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;shortbridge&#39;</span><span class="p">,</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;shortbridge&#39;</span><span class="p">,</span> <span class="s1">&#39;tc-cc-o&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc210&#39;</span><span class="p">:</span>            
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="n">ncorner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-t&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                        <span class="c1"># nterrace == 2 is terrace bridge and not </span>
                        <span class="c1"># equivalent to tc-cc-o for bcc210</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> 
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc211&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc310&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">cto2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">occurence</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-t&#39;</span>
                            <span class="k">elif</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m10t&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-t&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m11&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">cto2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">occurence</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
                            <span class="k">if</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;subsurf&#39;</span>
                                <span class="n">isubs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                         <span class="n">occurence</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="n">subpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">isubs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="mf">.5</span> <span class="o">*</span> <span class="n">get_mic</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">isubs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span>
                                         <span class="n">isubs</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">cto2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m12&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span>
                        <span class="n">ncorner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;step&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-t&#39;</span>
                        <span class="k">elif</span> <span class="n">ncorner</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;corner&#39;</span>
                        <span class="k">elif</span> <span class="n">nterrace</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot identify site </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">si</span><span class="p">))</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc100&#39;</span><span class="p">,</span><span class="s1">&#39;hcp0001&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;bridge&#39;</span><span class="p">,</span> <span class="s1">&#39;terrace&#39;</span>
                    
                    <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                    <span class="n">special</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">morphology</span> <span class="o">==</span> <span class="s1">&#39;terrace&#39;</span><span class="p">:</span>
                        <span class="n">special</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">extraids</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">occurence</span><span class="o">==</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">xi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">]</span>
                        <span class="c1">#if len(extraids) &lt; 2:</span>
                        <span class="c1">#    print(&#39;Cannot identify other 2 atoms of 4-fold site {}&#39;.format(si))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extraids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">extraids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extraids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                       <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">refpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                       <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>              
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                     <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">bridgeids</span> <span class="o">+</span> <span class="n">extraids</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m11&#39;</span> <span class="ow">and</span> <span class="n">morphology</span> <span class="o">==</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">:</span> 
                        <span class="n">special</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">extraids</span> <span class="o">=</span> <span class="n">si</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                     <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">subpos</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">bridgeids</span> <span class="o">+</span> <span class="n">isubs</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>                         
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>               
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                     <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>           
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m11&#39;</span> <span class="ow">and</span> <span class="n">morphology</span> <span class="o">==</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">:</span>
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">isubs</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">special</span><span class="p">:</span>
                            <span class="n">extrasymbols</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">xj</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">xj</span><span class="p">])</span> 
                                             <span class="k">for</span> <span class="n">xj</span> <span class="ow">in</span> <span class="n">extraids</span><span class="p">]</span>
                            <span class="n">extra</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extrasymbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">extracomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">])</span>
                            <span class="n">composition</span> <span class="o">+=</span> <span class="s1">&#39;-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extracomp</span><span class="p">)</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                    <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                    <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="n">fold4_surfaces</span> <span class="ow">and</span> <span class="n">fold4_poss</span><span class="p">:</span>
                    <span class="n">fold4atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="s1">&#39;X</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold4_poss</span><span class="p">)),</span> 
                                       <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fold4_poss</span><span class="p">),</span>
                                       <span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
                    <span class="n">sorted_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span>
                    <span class="n">ntop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_top</span><span class="p">)</span>
                    <span class="n">topatoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">[</span><span class="n">sorted_top</span><span class="p">]</span> 
                    <span class="n">newatoms</span> <span class="o">=</span> <span class="n">topatoms</span> <span class="o">+</span> <span class="n">fold4atoms</span>
                    <span class="n">newnblist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="n">newatoms</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> 
                                                    <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                    <span class="n">different_species</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                    <span class="n">mic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                     
                    <span class="c1"># Make 4-fold hollow sites</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">refpos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fold4_poss</span><span class="p">):</span>
                        <span class="n">fold4_indices</span> <span class="o">=</span> <span class="n">newnblist</span><span class="p">[</span><span class="n">ntop</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>                     
                        <span class="n">fold4ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sorted_top</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fold4_indices</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">fold4ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                       <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">refpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                       <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">occurence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">isub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">occurence</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                        
                        <span class="n">isub</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isub</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isub</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">isub</span> <span class="o">=</span> <span class="n">isub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">))</span> 
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">refpos</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_normal</span><span class="p">(</span>
                                 <span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">si</span><span class="p">:</span>
                            <span class="n">normals_for_site</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>

                        <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span> 
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hcp10m10t&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m11&#39;</span><span class="p">]:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;5fold&#39;</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                         <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                         <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">isub</span><span class="p">],</span>
                                         <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                         <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="o">+</span><span class="p">[</span><span class="n">isub</span><span class="p">]))})</span>
                        <span class="k">else</span><span class="p">:</span>                                                
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">]:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-t&#39;</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">]:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-t&#39;</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m12&#39;</span><span class="p">:</span>
                                <span class="n">morphology</span>  <span class="o">=</span> <span class="s1">&#39;tc-cc-t&#39;</span> 
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>

                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;4fold&#39;</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>               
                                         <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                         <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                         <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                         <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                         <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>                     
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>                        
                            <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fold4ids</span><span class="p">]</span>
                                <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mb</span>
                                <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                                <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                                        <span class="n">idd</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>        
                                              <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                        <span class="n">opp</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">idd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                            <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">close</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span>           
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">opp</span> <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">opposite</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>         
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                            <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                                <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                                <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                    <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">ma</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                                    <span class="n">opp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                              <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                    <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">opp</span> <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">opposite</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
                                    <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                                    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                                <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                            <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>                   
                                <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">])</span> <span class="o">+</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">this_site</span> <span class="o">!=</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="n">isub</span><span class="p">})</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> 
                                             <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">]})</span>
                        <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                        <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
             
            <span class="c1"># Make 3-fold hollow sites (differentiate fcc / hcp)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc100&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10t&#39;</span><span class="p">]:</span>
                <span class="n">coexist_3_4</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;bcc210&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m12&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">coexist_3_4</span><span class="p">:</span>
                    <span class="n">fold4_sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4fold&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">refpos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">):</span>
                    <span class="n">fold3_indices</span> <span class="o">=</span> <span class="n">nblist</span><span class="p">[</span><span class="n">ntop2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">fold3ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">top2_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fold3_indices</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ntop1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold3ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1">#if self.surface != &#39;hcp10m11&#39;:</span>
                        <span class="c1">#    si = tuple(sorted(fold3ids))</span>
                        <span class="c1">#    print(&#39;Cannot find the correct atoms of this 3-fold site.&#39;,</span>
                        <span class="c1">#          &#39;Find {} instead&#39;.format(si))</span>
                        <span class="k">continue</span>
                    <span class="c1"># Remove redundant 3-fold sites that belongs to 4-fold sites</span>
                    <span class="k">if</span> <span class="n">coexist_3_4</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fold3ids</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fold4_sets</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fold3ids</span><span class="p">))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">refpos</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span><span class="p">[</span><span class="n">fold3ids</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_normal</span><span class="p">(</span>
                             <span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">si</span><span class="p">:</span>
                        <span class="n">normals_for_site</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>

                    <span class="n">occurence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">fold3ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;fcc332&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hcp10m11&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m12&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">occurence</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>
                        <span class="n">siset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                        <span class="n">step_overlap</span> <span class="o">=</span> <span class="n">stepids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">)</span>
                        <span class="n">corner_overlap</span> <span class="o">=</span> <span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">step_overlap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">corner_overlap</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">corner_overlap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">step_overlap</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-h&#39;</span>
                        <span class="k">elif</span> <span class="n">step_overlap</span> <span class="ow">and</span> <span class="n">corner_overlap</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-h&#39;</span>    
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc210&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;3fold&#39;</span>
                        <span class="n">siset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                        <span class="n">step_overlap</span> <span class="o">=</span> <span class="n">stepids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">)</span>
                        <span class="n">corner_overlap</span> <span class="o">=</span> <span class="n">cornerids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">siset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">step_overlap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">corner_overlap</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                        <span class="k">elif</span> <span class="n">corner_overlap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">step_overlap</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;tc-cc-o&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc110&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;3fold&#39;</span><span class="p">,</span> <span class="s1">&#39;terrace&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc111&#39;</span><span class="p">:</span>
                        <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;3fold&#39;</span><span class="p">,</span> <span class="s1">&#39;sc-tc-cc-o&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span><span class="p">,</span> <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;3fold&#39;</span><span class="p">,</span> <span class="s1">&#39;sc-tc-o&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span><span class="s1">&#39;hcp0001&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">occurence</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]:</span>
                        <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-h&#39;</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">occurence</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>

                    <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>               
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                 <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                 <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                 <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                 <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                 <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>                       
                        <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>                            
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                            <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">)])</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>   

                    <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">:</span>
                        <span class="n">isub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">occurence</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                        
                        <span class="n">isub</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isub</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isub</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">isub</span> <span class="o">=</span> <span class="n">isub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">spos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">normal</span> <span class="o">*</span> <span class="n">dh</span>
                        <span class="k">if</span> <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">isub</span><span class="p">],</span> <span class="n">spos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                        <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2.</span><span class="p">:</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;fcc&#39;</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="n">isub</span><span class="p">})</span> 
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                                <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> 
                                              <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">]})</span>
                    <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                    <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
 
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="n">fold4_surfaces</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">):</span>
                <span class="n">fold4atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="s1">&#39;X</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">)),</span> 
                                   <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">),</span>
                                   <span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                                   <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
                <span class="n">sorted_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span>
                <span class="n">ntop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_top</span><span class="p">)</span>
                <span class="n">topatoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">[</span><span class="n">sorted_top</span><span class="p">]</span>
                <span class="n">newatoms</span> <span class="o">=</span> <span class="n">topatoms</span> <span class="o">+</span> <span class="n">fold4atoms</span>
                <span class="n">newnblist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="n">newatoms</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> 
                                                <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">different_species</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                <span class="n">mic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">refpos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reduced_poss</span><span class="p">):</span> 
                    <span class="n">fold4_indices</span> <span class="o">=</span> <span class="n">newnblist</span><span class="p">[</span><span class="n">ntop</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>            
                    <span class="n">fold4ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sorted_top</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fold4_indices</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">fold4ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                   <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">refpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                                   <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">4</span><span class="p">]</span>             
                    <span class="n">occurence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">isub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">occurence</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                    
                    <span class="n">isub</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isub</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isub</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">isub</span> <span class="o">=</span> <span class="n">isub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">refpos</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surface_normal</span><span class="p">(</span>
                             <span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">si</span><span class="p">:</span>
                        <span class="n">normals_for_site</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
                    
                    <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_site</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hcp10m10t&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m11&#39;</span><span class="p">]:</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;5fold&#39;</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                     <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">isub</span><span class="p">],</span>
                                     <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="o">+</span><span class="p">[</span><span class="n">isub</span><span class="p">]))})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">]:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-cc-t&#39;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">]:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;sc-tc-t&#39;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m12&#39;</span><span class="p">:</span>
                            <span class="n">morphology</span>  <span class="o">=</span> <span class="s1">&#39;tc-cc-t&#39;</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">morphology</span> <span class="o">=</span> <span class="s1">&#39;terrace&#39;</span>
                        <span class="n">this_site</span> <span class="o">=</span> <span class="s1">&#39;4fold&#39;</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="n">this_site</span><span class="p">,</span>
                                     <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                                     <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="n">morphology</span><span class="p">,</span>
                                     <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                                     <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                     <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>                       
                        <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">]</span>
                            <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                                    <span class="n">idd</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>       
                                          <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                    <span class="n">opp</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">idd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">idd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">close</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                            <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span>  
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">opp</span> <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">opposite</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>         
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">opp</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span> 
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">composition</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> 
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">ma</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                                <span class="n">opp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                          <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                                <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fold4ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                                <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">fold4ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">opp</span> <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">opposite</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
                                <span class="n">nni</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">]</span>
                                <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[[</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nni</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opp</span><span class="p">,</span> <span class="n">nni</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                            <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">])</span> <span class="o">+</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="n">this_site</span> <span class="o">!=</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                        <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="n">isub</span><span class="p">})</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">isub</span><span class="p">]})</span>
                    <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                    <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc110&#39;</span><span class="p">:</span>
            <span class="n">bcc110_long_bridges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">st_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">stids</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
            <span class="n">this_site</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
            <span class="c1"># Add normals to ontop sites                                </span>
            <span class="k">if</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">normals_for_site</span><span class="p">[</span><span class="n">stids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">nstids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nstids</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fold&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstids</span><span class="p">)</span>
                    <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stids</span><span class="p">))</span>

            <span class="c1"># Add normals to bridge sites</span>
            <span class="k">elif</span> <span class="s1">&#39;bridge&#39;</span> <span class="ow">in</span> <span class="n">this_site</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;terrace&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;corner&#39;</span><span class="p">]:</span>
                    <span class="n">normals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stids</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">normals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normals_for_site</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="n">nstids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nstids</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fold&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstids</span><span class="p">)</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stids</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;hcp10m10t&#39;</span><span class="p">:</span>
                        <span class="n">normals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> 
                                   <span class="o">==</span> <span class="s1">&#39;subsurf&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
                                   <span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Make sure sc-tc-x and tc-cc-x morphology are the same as x</span>
                        <span class="n">normals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span> <span class="k">if</span> 
                                   <span class="n">s</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                                   <span class="s1">&#39;bridge&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span>
                    <span class="n">t</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">nstids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nstids</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fold&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstids</span><span class="p">)</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stids</span><span class="p">))</span>
            
            <span class="c1"># Take care of duplicate fcc/hcp indices. When unit cell is </span>
            <span class="c1"># small, different sites can have exactly same indices</span>
            <span class="k">elif</span> <span class="n">this_site</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc&#39;</span><span class="p">,</span> <span class="s1">&#39;hcp&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">stids</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">:</span>
                    <span class="n">slid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">si</span> <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span> <span class="k">if</span> 
                                <span class="n">sl</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stids</span><span class="p">)</span>
                    <span class="n">previd</span> <span class="o">=</span> <span class="n">index_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stids</span><span class="p">)</span>
                    <span class="n">prevpos</span> <span class="o">=</span> <span class="n">pos_list</span><span class="p">[</span><span class="n">previd</span><span class="p">]</span>
                    <span class="n">prevst</span> <span class="o">=</span> <span class="n">st_list</span><span class="p">[</span><span class="n">previd</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prevpos</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> 
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]])</span> <span class="o">&lt;</span> \
                    <span class="nb">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">]]):</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>
                        <span class="k">if</span> <span class="n">prevst</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">:</span>
                            <span class="n">sl</span><span class="p">[</span><span class="n">slid</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">t</span><span class="p">[</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hcp&#39;</span>
                        <span class="k">if</span> <span class="n">prevst</span> <span class="o">==</span> <span class="s1">&#39;hcp&#39;</span><span class="p">:</span>
                            <span class="n">sl</span><span class="p">[</span><span class="n">slid</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fcc&#39;</span>
                        <span class="n">sl</span><span class="p">[</span><span class="n">slid</span><span class="p">][</span><span class="s1">&#39;subsurf_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                            <span class="n">sl</span><span class="p">[</span><span class="n">slid</span><span class="p">][</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                    <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>
                    <span class="n">st_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
            <span class="c1"># Take care of longbridge sites on bcc110</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc110&#39;</span> <span class="ow">and</span> <span class="n">this_site</span> <span class="o">==</span> <span class="s1">&#39;3fold&#39;</span><span class="p">:</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                         <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">bcc110_long_bridges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longest</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc110&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shortbridge&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bcc110_long_bridges</span><span class="p">:</span>
                        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;longbridge&#39;</span>

        <span class="c1"># Add 6-fold sites if allowed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_6fold</span><span class="p">:</span>            
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bridge&#39;</span> \
                <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
                    <span class="n">site</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>                     
                    <span class="n">subpos</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">sid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
                    <span class="n">occurence</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                    <span class="n">surfsi</span> <span class="o">=</span> <span class="n">sid</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">occurence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surfsi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">surfsi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">surfsi</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>        
                                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">subpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                        <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">4</span><span class="p">]</span>    
                    <span class="n">subsi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                             <span class="n">occurence</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subsi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">subsi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subsi</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_mic</span><span class="p">(</span>       
                                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">subpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span>
                                        <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>   
                    <span class="n">si</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">surfsi</span> <span class="o">+</span> <span class="n">subsi</span><span class="p">))</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">])</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;6fold&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">subpos</span><span class="p">,</span>
                                 <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">normal</span><span class="p">,</span>
                                 <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">si</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fcc&#39;</span><span class="p">:</span>
                    <span class="n">site</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">subpos</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">/</span> <span class="mi">2</span>                               
                    <span class="k">def</span> <span class="nf">get_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">subpos</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">subsi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="p">,</span> 
                                          <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>     
                    <span class="n">si</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;6fold&#39;</span><span class="p">,</span>      
                                 <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">subpos</span><span class="p">,</span>
                                 <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="s1">&#39;subsurf&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">si</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">subsi</span><span class="p">)))})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Find the opposite element</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                    <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]:</span>
                        <span class="n">newsi</span> <span class="o">=</span> <span class="n">surfsi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">subsi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surfsi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">metals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metals</span> 
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">comp</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newsi</span><span class="p">]</span>
                            <span class="n">nma</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">comp</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">comp</span> <span class="o">=</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">comp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span>
                            <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">comp</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">si</span><span class="p">)])</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                            <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>

                    <span class="k">def</span> <span class="nf">get_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">get_mic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">subpos</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">return_squared_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
                        <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="n">metals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">subsyms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">subi</span><span class="p">]</span> <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">subsi</span><span class="p">]</span>
                        <span class="n">nma</span> <span class="o">=</span> <span class="n">subsyms</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">mb</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">ia</span> <span class="o">=</span> <span class="n">subsi</span><span class="p">[</span><span class="n">subsyms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ma</span><span class="p">)]</span>
                            <span class="n">subpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)]</span> <span class="o">==</span> <span class="n">ma</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span> <span class="o">+</span> <span class="n">ma</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="n">ma</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">mb</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">ib</span> <span class="o">=</span> <span class="n">subsi</span><span class="p">[</span><span class="n">subsyms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mb</span><span class="p">)]</span>
                            <span class="n">subpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)]</span> <span class="o">==</span> <span class="n">mb</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span> <span class="o">+</span> <span class="n">mb</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="n">mb</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">ma</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">nma</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">composition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">comp</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ma</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>                        
                        <span class="n">endsym</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Z][^A-Z]*&#39;</span><span class="p">,</span> <span class="n">comp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">subpos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">si</span> <span class="k">if</span> 
                                  <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">endsym</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">subsi</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_squared_distance</span><span class="p">)])</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">get_max_delta_sum_path</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
                        <span class="n">composition</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">chemical_symbols</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="n">composition</span><span class="p">})</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                <span class="n">usi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.populate_opposite_site_list"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.populate_opposite_site_list">[docs]</a>    <span class="k">def</span> <span class="nf">populate_opposite_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect the sites on the opposite side of the slab.&quot;&quot;&quot;</span>

        <span class="n">top_surf_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">top_subsurf_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="n">top_site_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_termination</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_site_list</span><span class="p">(</span><span class="n">_bot_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span> <span class="o">=</span> <span class="n">top_surf_ids</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span> <span class="o">=</span> <span class="n">top_subsurf_ids</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsurf_ids</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span><span class="p">:</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">]</span> \
            <span class="ow">and</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;5fold&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ontop&#39;</span><span class="p">:</span>                
                <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="o">=</span> <span class="n">top_site_list</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_site"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_site">[docs]</a>    <span class="k">def</span> <span class="nf">get_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information of a site given its atom indices.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : list or tuple</span>
<span class="sd">            The indices of the atoms that contribute to the site.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        <span class="n">st</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span> <span class="k">if</span> 
                   <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">indices</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                                                                 
                  <span class="n">morphology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">composition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">subsurf_element</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information of all sites.</span>
<span class="sd">                                                                     </span>
<span class="sd">        Parameters                                                   </span>
<span class="sd">        ----------                                                   </span>
<span class="sd">        site : str, default None</span>
<span class="sd">            Only return sites that belongs to this site type.</span>

<span class="sd">        morphology : str, default None</span>
<span class="sd">            Only return sites with this local surface morphology.</span>

<span class="sd">        composition : str, default None</span>
<span class="sd">            Only return sites that have this composition.</span>

<span class="sd">        subsurf_element : str, default None</span>
<span class="sd">            Only return sites that have this subsurface element.</span>
<span class="sd">                                                                     </span>
<span class="sd">        &quot;&quot;&quot;</span>                                                          

        <span class="n">all_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">morphology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">morphology</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">composition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">composition</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">composition</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">scomp</span> <span class="o">=</span> <span class="n">composition</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[A-Z][^A-Z]*&#39;</span><span class="p">,</span> <span class="n">composition</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                           <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                                               <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">scomp</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">scomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">scomp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subsurf_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">]</span> 
                         <span class="o">==</span> <span class="n">subsurf_element</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">all_sites</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_unique_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_unique_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_unique_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_composition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                
                         <span class="n">unique_subsurf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all symmetry-inequivalent adsorption sites.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unique_composition : bool, default False</span>
<span class="sd">            Take site composition into consideration when </span>
<span class="sd">            checking uniqueness.</span>

<span class="sd">        unique_subsurf : bool, default False</span>
<span class="sd">            Take subsurface element into consideration when </span>
<span class="sd">            checking uniqueness.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;morphology&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unique_composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the site list does not include &#39;</span>
                                 <span class="o">+</span> <span class="s1">&#39;information of composition&#39;</span><span class="p">)</span>
            <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;composition&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_subsurf</span><span class="p">:</span>
                <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;subsurf_element&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unique_subsurf</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;to include the subsurface element, &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;unique_composition also need to be set to True&#39;</span><span class="p">)</span> 
        <span class="n">sklist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([[</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">])</span>
 
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sklist</span> <span class="k">for</span> <span class="n">sklist</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">sklist</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Assign labels</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_effect</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]]</span>                      
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]]</span>
            <span class="n">stlab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_dict</span><span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signature</span><span class="p">)]</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stlab</span>                                                        

    <span class="k">def</span> <span class="nf">new_site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;morphology&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;composition&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;subsurf_index&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;subsurf_element&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

<div class="viewcode-block" id="SlabAdsorptionSites.mapping"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.mapping">[docs]</a>    <span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map the slab into a proxy reference slab for code versatility.&quot;&quot;&quot;</span>

        <span class="n">ref_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_metal</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc100&#39;</span><span class="p">,</span><span class="s1">&#39;fcc110&#39;</span><span class="p">,</span><span class="s1">&#39;fcc311&#39;</span><span class="p">,</span><span class="s1">&#39;fcc221&#39;</span><span class="p">,</span><span class="s1">&#39;fcc331&#39;</span><span class="p">,</span><span class="s1">&#39;fcc322&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fcc332&#39;</span><span class="p">,</span><span class="s1">&#39;bcc210&#39;</span><span class="p">,</span><span class="s1">&#39;bcc211&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mf">50.</span><span class="p">:</span>
                <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Cu&#39;</span> <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Pt&#39;</span> <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc111&#39;</span><span class="p">,</span><span class="s1">&#39;fcc211&#39;</span><span class="p">,</span><span class="s1">&#39;bcc111&#39;</span><span class="p">,</span><span class="s1">&#39;hcp0001&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10h&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hcp10m12&#39;</span><span class="p">]:</span>
            <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Cu&#39;</span> <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bcc100&#39;</span><span class="p">,</span><span class="s1">&#39;bcc110&#39;</span><span class="p">,</span><span class="s1">&#39;bcc310&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m10t&#39;</span><span class="p">,</span><span class="s1">&#39;hcp10m11&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="mf">50.</span><span class="p">:</span>
                <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Cu&#39;</span> <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_symbol</span> <span class="o">=</span> <span class="s1">&#39;Au&#39;</span> <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;surface </span><span class="si">{}</span><span class="s1"> is not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ref_atoms</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">ref_symbol</span>
        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">asapEMT</span><span class="p">()</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">BFGS</span><span class="p">(</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">centered_atoms</span> <span class="o">=</span> <span class="n">ref_atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">centered_atoms</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">vacuum</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">midz</span> <span class="o">=</span> <span class="n">centered_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">top_surf_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centered_atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">midz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">3.</span><span class="p">:</span>
                <span class="n">top_surf_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">midz</span><span class="p">:</span>
                <span class="n">top_surf_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">top_surf_indices</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ref_atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">vacuum</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 
        <span class="n">ref_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="kc">None</span>                      
        <span class="n">delta_positions</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">positions</span> <span class="o">-</span> <span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span>

        <span class="k">return</span> <span class="n">ref_atoms</span><span class="p">,</span> <span class="n">delta_positions</span></div>

    <span class="k">def</span> <span class="nf">make_neighbor_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nblist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> 
                                          <span class="n">neighbor_number</span><span class="p">,</span> <span class="n">mic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="SlabAdsorptionSites.get_connectivity"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">get_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                      
        <span class="sd">&quot;&quot;&quot;Get the connection matrix.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">get_connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nblist</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_termination"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_termination">[docs]</a>    <span class="k">def</span> <span class="nf">get_termination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the indices of surface and subsurface atoms. This </span>
<span class="sd">        function relies on coordination number and the connectivity </span>
<span class="sd">        of the atoms. The top surface termination is singled out by </span>
<span class="sd">        graph connectivity using networkx.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        side : string, default &#39;top&#39;</span>
<span class="sd">            The side of the surface termination (&#39;top&#39; or &#39;bottom&#39;).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">]</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>                               
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> 
        <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">allsurf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bulk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">==</span> <span class="s1">&#39;bcc210&#39;</span><span class="p">:</span>
            <span class="n">max_coord</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
            <span class="n">a_s</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">max_coord</span><span class="p">:</span>  
                <span class="n">bulk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allsurf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_s</span><span class="p">)</span>
        <span class="n">surfcm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">surfcm</span><span class="p">[</span><span class="n">bulk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">surfcm</span><span class="p">[:,</span><span class="n">bulk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Use networkx to separate top layer and bottom layer</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">surfcm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">cols</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> 
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="mi">2</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
            <span class="n">surf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">components</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ref_atoms</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">subsurf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a_b</span> <span class="ow">in</span> <span class="n">bulk</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_t</span> <span class="ow">in</span> <span class="n">surf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">a_t</span><span class="p">,</span> <span class="n">a_b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">subsurf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_b</span><span class="p">)</span>
        <span class="n">subsurf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subsurf</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">surf</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subsurf</span><span class="p">)</span></div>
 
    <span class="k">def</span> <span class="nf">get_two_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">vec1</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">vec2</span> <span class="o">=</span> <span class="n">get_mic</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span>

<div class="viewcode-block" id="SlabAdsorptionSites.get_surface_normal"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_surface_normal">[docs]</a>    <span class="k">def</span> <span class="nf">get_surface_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the surface normal vector of the plane from the indices </span>
<span class="sd">        of 3 atoms that forms to that plane.                                    </span>
<span class="sd">                                                                    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : list of tuple</span>
<span class="sd">            The indices of the atoms that forms the plane.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_two_vectors</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">@</span> <span class="n">n</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">n</span> <span class="o">/=</span> <span class="n">l</span>
        <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_graph"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                              
        <span class="sd">&quot;&quot;&quot;Get the graph representation of the nanoparticle.&quot;&quot;&quot;</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_matrix</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>                                                  
        <span class="c1"># Add edges from surface connectivity matrix</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">cols</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.get_neighbor_site_list"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.get_neighbor_site_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighbor_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>           
        <span class="sd">&quot;&quot;&quot;Returns the site_list index of all neighbor shell sites </span>
<span class="sd">        for each site.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        neighbor_number : int, default 1</span>
<span class="sd">            Neighbor shell number. </span>

<span class="sd">        span : bool, default True</span>
<span class="sd">            Whether to include all neighbors sites spanned within </span>
<span class="sd">            the shell.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">refposs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">delta_positions</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span>
                             <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">]</span> <span class="o">*</span> \
                             <span class="n">site_heights</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">])</span>
        <span class="n">statoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="s1">&#39;X</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)),</span> 
                        <span class="n">positions</span><span class="o">=</span><span class="n">refposs</span><span class="p">,</span> 
                        <span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> 
                        <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="mf">0.55</span> 
        <span class="k">if</span> <span class="n">neighbor_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cr</span> <span class="o">+=</span> <span class="mf">0.1</span>

        <span class="n">nbslist</span> <span class="o">=</span> <span class="n">neighbor_shell_list</span><span class="p">(</span><span class="n">statoms</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">neighbor_number</span><span class="p">,</span>
                                      <span class="n">mic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">cr</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neighbor_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">top_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surf_ids</span><span class="p">)</span>
            <span class="n">topi_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ontop&#39;</span><span class="p">:</span>
                    <span class="n">topi_dict</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">elif</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fcc&#39;</span><span class="p">,</span><span class="s1">&#39;hcp&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">topi_dict</span><span class="p">:</span>
                            <span class="n">nbslist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topi_dict</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  
        <span class="k">return</span> <span class="n">nbslist</span></div>

<div class="viewcode-block" id="SlabAdsorptionSites.update"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.SlabAdsorptionSites.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">update_composition</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the position and composition of each adsorption site </span>
<span class="sd">        given an updated atoms object. Please only use this when the </span>
<span class="sd">        indexing of the atoms object is preserved. Useful for updating</span>
<span class="sd">        adsorption sites e.g. after geometry optimization.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atoms : ase.Atoms object</span>
<span class="sd">            The updated atoms object. </span>

<span class="sd">        update_composition : bool, default False</span>
<span class="sd">            Whether to update the composition as well. It is recommended</span>
<span class="sd">            to only set update_composition=True if the composition of </span>
<span class="sd">            the surface is not fixed.  </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_list</span>
        <span class="n">new_slab</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> 
                          <span class="n">a</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adsorbate_elements</span><span class="p">]]</span>
        <span class="n">dvecs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_mic</span><span class="p">(</span><span class="n">new_slab</span><span class="o">.</span><span class="n">positions</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">])</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dvecs</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">update_composition</span><span class="p">:</span>
                <span class="n">newcomp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span>
                                         <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                <span class="n">st</span><span class="p">[</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcomp</span>                           </div></div>


<div class="viewcode-block" id="get_adsorption_site"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.get_adsorption_site">[docs]</a><span class="k">def</span> <span class="nf">get_adsorption_site</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> 
                        <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">return_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function that returns the information of a site given the</span>
<span class="sd">    indices of the atoms that contribute to the site. The function </span>
<span class="sd">    is generalized for both periodic and non-periodic systems</span>
<span class="sd">    (distinguished by atoms.pbc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    indices : list or tuple</span>
<span class="sd">        The indices of the atoms that contribute to the site.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices)</span>
<span class="sd">        Only required for periodic surface slabs.</span>

<span class="sd">    return_index : bool, default False</span>
<span class="sd">        Whether to return the site index of the site list</span>
<span class="sd">        together with the site.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    This is an example of getting the site information of the</span>
<span class="sd">    (24, 29, 31) 3-fold hollow site on a fcc110 surface:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import get_adsorption_site</span>
<span class="sd">        &gt;&gt;&gt; from ase.build import fcc110</span>
<span class="sd">        &gt;&gt;&gt; atoms = fcc110(&#39;Cu&#39;, (2, 2, 8), vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; for atom in atoms:</span>
<span class="sd">        ...     if atom.index % 2 == 0:</span>
<span class="sd">        ...         atom.symbol = &#39;Au&#39;</span>
<span class="sd">        &gt;&gt;&gt; atoms.center()</span>
<span class="sd">        &gt;&gt;&gt; site = get_adsorption_site(atoms, (24, 29, 31), surface=&#39;fcc110&#39;) </span>
<span class="sd">        &gt;&gt;&gt; print(site)</span>

<span class="sd">    Output:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {&#39;site&#39;: &#39;fcc&#39;, &#39;surface&#39;: &#39;fcc110&#39;, &#39;morphology&#39;: &#39;sc-tc-h&#39;, </span>
<span class="sd">         &#39;position&#39;: array([ 3.91083333,  1.91449161, 13.5088516 ]), </span>
<span class="sd">         &#39;normal&#39;: array([-0.57735027,  0.        ,  0.81649658]), </span>
<span class="sd">         &#39;indices&#39;: (24, 29, 31), &#39;composition&#39;: &#39;CuCuAu&#39;, </span>
<span class="sd">         &#39;subsurf_index&#39;: None, &#39;subsurf_element&#39;: None, &#39;label&#39;: None}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="k">if</span> <span class="n">is_list_or_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>                                        
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>

    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">composition_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                                                             
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> 
                                  <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                  <span class="n">composition_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>             
    <span class="n">site_list</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
    <span class="n">sti</span><span class="p">,</span> <span class="n">site</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(((</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span> <span class="k">if</span>                        
                      <span class="n">s</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">indices</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>                     

    <span class="k">if</span> <span class="n">return_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sti</span><span class="p">,</span> <span class="n">site</span>
                    
    <span class="k">return</span> <span class="n">site</span>    </div>


<div class="viewcode-block" id="enumerate_adsorption_sites"><a class="viewcode-back" href="../../modules.html#acat.adsorption_sites.enumerate_adsorption_sites">[docs]</a><span class="k">def</span> <span class="nf">enumerate_adsorption_sites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                               <span class="n">morphology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                               <span class="n">allow_6fold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">composition_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">both_sides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">label_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function that enumerates all adsorption sites of the </span>
<span class="sd">    input atoms object. The function is generalized for both </span>
<span class="sd">    periodic and non-periodic systems (distinguished by atoms.pbc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : ase.Atoms object</span>
<span class="sd">        Accept any ase.Atoms object. No need to be built-in.</span>

<span class="sd">    surface : str, default None</span>
<span class="sd">        The surface type (crystal structure + Miller indices).</span>
<span class="sd">        If the structure is a periodic surface slab, this is required.</span>
<span class="sd">        If the structure is a nanoparticle, the function enumerates</span>
<span class="sd">        only the sites on the specified surface.</span>

<span class="sd">    morphology : str, default None</span>
<span class="sd">        The function enumerates only the sites of the specified </span>
<span class="sd">        local surface morphology. Only available for surface slabs.</span>

<span class="sd">    allow_6fold : bool, default False</span>
<span class="sd">        Whether to allow the adsorption on 6-fold subsurf sites </span>
<span class="sd">        underneath fcc hollow sites.</span>
<span class="sd"> </span>
<span class="sd">    composition_effect : bool, default False</span>
<span class="sd">        Whether to consider sites with different elemental </span>
<span class="sd">        compositions as different sites. It is recommended to </span>
<span class="sd">        set composition_effect=False for monometallics.</span>

<span class="sd">    both_sides : bool, default False</span>
<span class="sd">        Whether to consider sites on both top and bottom sides</span>
<span class="sd">        of the slab. Only relevant for periodic surface slabs.</span>

<span class="sd">    label_sites : bool, default False</span>
<span class="sd">        Whether to assign a numerical label to each site.</span>
<span class="sd">        Labels for different sites are listed in acat.labels.</span>
<span class="sd">        Use the bimetallic labels if composition_effect=True,</span>
<span class="sd">        otherwise use the monometallic labels.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    This is an example of enumerating all sites on the fcc100 surfaces</span>
<span class="sd">    of a Marks decahedral nanoparticle:</span>

<span class="sd">        &gt;&gt;&gt; from acat.adsorption_sites import enumerate_adsorption_sites</span>
<span class="sd">        &gt;&gt;&gt; from ase.cluster import Decahedron</span>
<span class="sd">        &gt;&gt;&gt; atoms = Decahedron(&#39;Pb&#39;, p=3, q=2, r=1)</span>
<span class="sd">        &gt;&gt;&gt; for atom in atoms:</span>
<span class="sd">        ...     if atom.index % 2 == 0:</span>
<span class="sd">        ...         atom.symbol = &#39;Ag&#39;</span>
<span class="sd">        &gt;&gt;&gt; atoms.center(vacuum=5.)</span>
<span class="sd">        &gt;&gt;&gt; sites = enumerate_adsorption_sites(atoms, surface=&#39;fcc100&#39;,</span>
<span class="sd">        ...                                    composition_effect=True) </span>
<span class="sd">        &gt;&gt;&gt; print(sites[0])</span>

<span class="sd">    Output:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {&#39;site&#39;: &#39;4fold&#39;, &#39;surface&#39;: &#39;fcc100&#39;, </span>
<span class="sd">         &#39;position&#39;: array([22.63758191, 21.69793997, 13.75044642]), </span>
<span class="sd">         &#39;normal&#39;: array([ 0.58778525,  0.80901699, -0.        ]), </span>
<span class="sd">         &#39;indices&#39;: (116, 117, 118, 119), &#39;composition&#39;: &#39;AgAgPbPb&#39;, </span>
<span class="sd">         &#39;subsurf_index&#39;: 75, &#39;subsurf_element&#39;: &#39;Pb&#39;, &#39;label&#39;: None}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pbc</span><span class="p">:</span>
        <span class="n">cas</span> <span class="o">=</span> <span class="n">ClusterAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">allow_6fold</span><span class="p">,</span>
                                     <span class="n">composition_effect</span><span class="p">,</span>
                                     <span class="n">label_sites</span><span class="p">)</span>
        <span class="n">all_sites</span> <span class="o">=</span> <span class="n">cas</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">surface</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">surface</span><span class="p">]</span> 

    <span class="k">else</span><span class="p">:</span>
        <span class="n">sas</span> <span class="o">=</span> <span class="n">SlabAdsorptionSites</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span>
                                  <span class="n">allow_6fold</span><span class="p">,</span> 
                                  <span class="n">composition_effect</span><span class="p">,</span>
                                  <span class="n">both_sides</span><span class="p">,</span>
                                  <span class="n">label_sites</span><span class="p">)</span>            
        <span class="n">all_sites</span> <span class="o">=</span> <span class="n">sas</span><span class="o">.</span><span class="n">site_list</span>
        <span class="k">if</span> <span class="n">morphology</span><span class="p">:</span>
            <span class="n">all_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_sites</span> <span class="k">if</span> 
                         <span class="n">s</span><span class="p">[</span><span class="s1">&#39;morphology&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">morphology</span><span class="p">]</span>       

    <span class="k">return</span> <span class="n">all_sites</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Shuang Han.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>